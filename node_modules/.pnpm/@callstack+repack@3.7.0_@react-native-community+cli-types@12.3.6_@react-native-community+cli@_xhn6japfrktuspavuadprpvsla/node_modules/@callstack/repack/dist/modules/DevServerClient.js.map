{"version":3,"file":"DevServerClient.js","names":["prettyFormat","getDevServerLocation","DevServerClient","buffer","constructor","initSocket","address","host","socket","WebSocket","onClose","event","console","warn","message","undefined","onclose","onerror","onopen","flushBuffer","__DEV__","send","level","data","JSON","stringify","type","map","item","escapeString","highlight","maxDepth","min","plugins","ReactElement","log","readyState","OPEN","push","client","module","exports","setup","enable","disable","registerBundle"],"sources":["../../src/modules/DevServerClient.ts"],"sourcesContent":["/* eslint-env browser */\n/* global __DEV__ */\n\nimport prettyFormat from 'pretty-format';\nimport { getDevServerLocation } from './getDevServerLocation';\n\n/**\n * With Webpack we don't use built-in metro-specific HMR client,\n * so the module `react-native/Libraries/Utilities/HMRClient.js` should be replaced with this one.\n *\n * Most of the code is noop apart from the `log` function which handles sending logs from client\n * application to the dev server.\n *\n * The console gets \"polyfilled\" here:\n * https://github.com/facebook/react-native/blob/v0.63.4/Libraries/Core/setUpDeveloperTools.js#L51-L69\n */\n\nclass DevServerClient {\n  socket?: WebSocket;\n  buffer: Array<{ level: string; data: any[] }> = [];\n\n  constructor() {\n    const initSocket = () => {\n      const address = `ws://${getDevServerLocation().host}/__client`;\n      this.socket = new WebSocket(address);\n\n      const onClose = (event: Event) => {\n        console.warn(\n          'Disconnected from the Dev Server:',\n          (event as unknown as { message: string | null }).message\n        );\n        this.socket = undefined;\n      };\n\n      this.socket.onclose = onClose;\n      this.socket.onerror = onClose;\n      this.socket.onopen = () => {\n        this.flushBuffer();\n      };\n    };\n\n    if (__DEV__) {\n      initSocket();\n    }\n  }\n\n  send(level: string, data: any[]) {\n    try {\n      this.socket?.send(\n        JSON.stringify({\n          type: 'client-log',\n          level,\n          data: data.map((item: any) =>\n            typeof item === 'string'\n              ? item\n              : prettyFormat(item, {\n                  escapeString: true,\n                  highlight: true,\n                  maxDepth: 3,\n                  min: true,\n                  plugins: [prettyFormat.plugins.ReactElement],\n                })\n          ),\n        })\n      );\n    } catch {\n      // Ignore error\n    }\n  }\n\n  flushBuffer() {\n    for (const { level, data } of this.buffer) {\n      this.send(level, data);\n    }\n\n    this.buffer = [];\n  }\n\n  log(level: string, data: any[]) {\n    if (this.socket && this.socket.readyState === WebSocket.OPEN) {\n      this.flushBuffer();\n      this.send(level, data);\n    } else {\n      this.buffer.push({ level, data });\n    }\n  }\n}\n\nconst client = new DevServerClient();\n\nmodule.exports = {\n  setup() {},\n  enable() {},\n  disable() {},\n  registerBundle() {},\n  log(level: string, data: any[]) {\n    client.log(level, data);\n  },\n};\n"],"mappings":"AAAA;;AACA;AAEA,OAAOA,YAAP,MAAyB,eAAzB;AACA,SAASC,oBAAT,QAAqC,wBAArC;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,MAAMC,eAAN,CAAsB;EAEpBC,MAAM,GAA0C,EAA1C;;EAENC,WAAW,GAAG;IACZ,MAAMC,UAAU,GAAG,MAAM;MACvB,MAAMC,OAAO,GAAI,QAAOL,oBAAoB,GAAGM,IAAK,WAApD;MACA,KAAKC,MAAL,GAAc,IAAIC,SAAJ,CAAcH,OAAd,CAAd;;MAEA,MAAMI,OAAO,GAAIC,KAAD,IAAkB;QAChCC,OAAO,CAACC,IAAR,CACE,mCADF,EAEGF,KAAD,CAAiDG,OAFnD;QAIA,KAAKN,MAAL,GAAcO,SAAd;MACD,CAND;;MAQA,KAAKP,MAAL,CAAYQ,OAAZ,GAAsBN,OAAtB;MACA,KAAKF,MAAL,CAAYS,OAAZ,GAAsBP,OAAtB;;MACA,KAAKF,MAAL,CAAYU,MAAZ,GAAqB,MAAM;QACzB,KAAKC,WAAL;MACD,CAFD;IAGD,CAjBD;;IAmBA,IAAIC,OAAJ,EAAa;MACXf,UAAU;IACX;EACF;;EAEDgB,IAAI,CAACC,KAAD,EAAgBC,IAAhB,EAA6B;IAC/B,IAAI;MACF,KAAKf,MAAL,EAAaa,IAAb,CACEG,IAAI,CAACC,SAAL,CAAe;QACbC,IAAI,EAAE,YADO;QAEbJ,KAFa;QAGbC,IAAI,EAAEA,IAAI,CAACI,GAAL,CAAUC,IAAD,IACb,OAAOA,IAAP,KAAgB,QAAhB,GACIA,IADJ,GAEI5B,YAAY,CAAC4B,IAAD,EAAO;UACjBC,YAAY,EAAE,IADG;UAEjBC,SAAS,EAAE,IAFM;UAGjBC,QAAQ,EAAE,CAHO;UAIjBC,GAAG,EAAE,IAJY;UAKjBC,OAAO,EAAE,CAACjC,YAAY,CAACiC,OAAb,CAAqBC,YAAtB;QALQ,CAAP,CAHZ;MAHO,CAAf,CADF;IAiBD,CAlBD,CAkBE,MAAM,CACN;IACD;EACF;;EAEDf,WAAW,GAAG;IACZ,KAAK,MAAM;MAAEG,KAAF;MAASC;IAAT,CAAX,IAA8B,KAAKpB,MAAnC,EAA2C;MACzC,KAAKkB,IAAL,CAAUC,KAAV,EAAiBC,IAAjB;IACD;;IAED,KAAKpB,MAAL,GAAc,EAAd;EACD;;EAEDgC,GAAG,CAACb,KAAD,EAAgBC,IAAhB,EAA6B;IAC9B,IAAI,KAAKf,MAAL,IAAe,KAAKA,MAAL,CAAY4B,UAAZ,KAA2B3B,SAAS,CAAC4B,IAAxD,EAA8D;MAC5D,KAAKlB,WAAL;MACA,KAAKE,IAAL,CAAUC,KAAV,EAAiBC,IAAjB;IACD,CAHD,MAGO;MACL,KAAKpB,MAAL,CAAYmC,IAAZ,CAAiB;QAAEhB,KAAF;QAASC;MAAT,CAAjB;IACD;EACF;;AApEmB;;AAuEtB,MAAMgB,MAAM,GAAG,IAAIrC,eAAJ,EAAf;AAEAsC,MAAM,CAACC,OAAP,GAAiB;EACfC,KAAK,GAAG,CAAE,CADK;;EAEfC,MAAM,GAAG,CAAE,CAFI;;EAGfC,OAAO,GAAG,CAAE,CAHG;;EAIfC,cAAc,GAAG,CAAE,CAJJ;;EAKfV,GAAG,CAACb,KAAD,EAAgBC,IAAhB,EAA6B;IAC9BgB,MAAM,CAACJ,GAAP,CAAWb,KAAX,EAAkBC,IAAlB;EACD;;AAPc,CAAjB"}