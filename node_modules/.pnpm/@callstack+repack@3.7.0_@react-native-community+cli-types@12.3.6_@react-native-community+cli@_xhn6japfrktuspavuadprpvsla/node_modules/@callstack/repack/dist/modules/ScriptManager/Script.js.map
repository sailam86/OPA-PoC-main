{"version":3,"file":"Script.js","names":["shallowEqual","Script","DEFAULT_TIMEOUT","getDevServerURL","scriptId","webpackContext","p","u","getFileSystemURL","getRemoteURL","url","options","excludeExtension","from","key","locator","fetch","headers","Headers","forEach","value","toLowerCase","body","FormData","bodyObject","console","warn","JSON","stringify","URLSearchParams","undefined","Error","caller","method","absolute","timeout","query","toString","Object","keys","length","cache","verifyScriptSignature","constructor","shouldUpdateCache","cachedData","checkIfCacheDataOutdated","shouldRefetch","diffs","some","diff","getCacheData","toObject"],"sources":["../../../src/modules/ScriptManager/Script.ts"],"sourcesContent":["/* globals Headers, FormData */\n\nimport shallowEqual from 'shallowequal';\nimport type {\n  NormalizedScriptLocator,\n  ScriptLocator,\n  WebpackContext,\n} from './types';\n\n/**\n * Representation of a Script to load and execute, used by {@link ScriptManager}.\n *\n * When adding resolvers to `ScriptManager` in `ScriptManager.shared.addResolver(...)`, you can use\n * `Script.getDevServerURL(...)`, `Script.getFileSystemURL(...)` or `Script.getRemoteURL(...)`\n * to create a `url` for the script.\n *\n * Other methods are designed for internal use only.\n */\nexport class Script {\n  static DEFAULT_TIMEOUT = 30000; // 30s\n\n  /**\n   * Get URL of a script hosted on development server.\n   *\n   * @param scriptId Id of the script.\n   */\n  static getDevServerURL(scriptId: string) {\n    return (webpackContext: WebpackContext) =>\n      `${webpackContext.p}${webpackContext.u(scriptId)}`;\n  }\n\n  /**\n   * Get URL of a script stored on filesystem on the target mobile device.\n   *\n   * @param scriptId Id of the script.\n   */\n  static getFileSystemURL(scriptId: string) {\n    return (webpackContext: WebpackContext) =>\n      webpackContext.u(`file:///${scriptId}`);\n  }\n\n  /**\n   * Get URL of a script hosted on a remote server.\n   *\n   * By default `.chunk.bundle` extension will be added to the URL.\n   * If your script has different extension, you should pass `{ excludeExtension: true }` as 2nd argument.\n   *\n   * @param url A URL to remote location where the script is stored.\n   * @param options Additional options.\n   */\n  static getRemoteURL(\n    url: string,\n    options: { excludeExtension?: boolean } = {}\n  ) {\n    if (options.excludeExtension) {\n      return url;\n    }\n\n    return (webpackContext: WebpackContext) => webpackContext.u(url);\n  }\n\n  /**\n   * Create new instance of `Script` from non-normalized script locator data.\n   *\n   * @param locator Non-normalized locator data.\n   * @param fetch Initial flag for whether script should be fetched or not.\n   *\n   * @internal\n   */\n  static from(\n    key: { scriptId: string; caller?: string },\n    locator: ScriptLocator,\n    fetch: boolean\n  ) {\n    const headers: Record<string, string> = {};\n    new Headers(locator.headers).forEach((value: string, key: string) => {\n      headers[key.toLowerCase()] = value;\n    });\n\n    let body: NormalizedScriptLocator['body'];\n    if (locator.body instanceof FormData) {\n      const bodyObject: Record<string, string> = {};\n      locator.body.forEach((value, key) => {\n        if (typeof value === 'string') {\n          bodyObject[key] = value;\n        } else {\n          console.warn('Script does not support File as FormData key in body');\n        }\n      });\n      body = JSON.stringify(bodyObject);\n    } else if (locator.body instanceof URLSearchParams) {\n      const bodyObject: Record<string, string> = {};\n      locator.body.forEach((value, key) => {\n        bodyObject[key] = value;\n      });\n      body = JSON.stringify(bodyObject);\n    } else {\n      body = locator.body ?? undefined;\n    }\n\n    if (typeof locator.url === 'function') {\n      throw new Error('Property url as a function is not support');\n    }\n\n    return new Script(\n      key.scriptId,\n      key.caller,\n      {\n        method: locator.method ?? 'GET',\n        url: locator.url,\n        absolute: locator.absolute ?? false,\n        timeout: locator.timeout ?? Script.DEFAULT_TIMEOUT,\n        query: new URLSearchParams(locator.query).toString() || undefined,\n        body,\n        headers: Object.keys(headers).length ? headers : undefined,\n        fetch: locator.cache === false ? true : fetch,\n        verifyScriptSignature: locator.verifyScriptSignature ?? 'off',\n      },\n      locator.cache\n    );\n  }\n\n  /**\n   * Constructs new representation of a script.\n   *\n   * @param locator Normalized locator data.\n   * @param cache Flag whether use cache or not, `true` by default.\n   *\n   * @internal\n   */\n  constructor(\n    public readonly scriptId: string,\n    public readonly caller: string | undefined,\n    public readonly locator: NormalizedScriptLocator,\n    public readonly cache: boolean = true\n  ) {}\n\n  /**\n   * Check if the script was already cached and cache should be updated with new data.\n   *\n   * @param cachedData Cached data for the same script.\n   *\n   * @internal\n   */\n  shouldUpdateCache(\n    cachedData: Pick<\n      NormalizedScriptLocator,\n      'method' | 'url' | 'query' | 'headers' | 'body'\n    >\n  ) {\n    if (!this.cache || !cachedData) {\n      return false;\n    }\n\n    return this.checkIfCacheDataOutdated(cachedData);\n  }\n\n  /**\n   * Check if the script should be fetched again or reused,\n   * based on previous cached data.\n   *\n   * @param cachedData Cached data for the same script.\n   *\n   * @internal\n   */\n  shouldRefetch(\n    cachedData: Pick<\n      NormalizedScriptLocator,\n      'method' | 'url' | 'query' | 'headers' | 'body'\n    >\n  ) {\n    if (!this.cache) {\n      return true;\n    }\n\n    return this.checkIfCacheDataOutdated(cachedData);\n  }\n\n  /**\n   * Check if previous cached data is the same as the new one.\n   *\n   * @param cachedData Cached data for the same script.\n   *\n   * @internal\n   */\n  checkIfCacheDataOutdated(\n    cachedData: Pick<\n      NormalizedScriptLocator,\n      'method' | 'url' | 'query' | 'headers' | 'body'\n    >\n  ) {\n    const diffs = [\n      cachedData.method !== this.locator.method,\n      cachedData.url !== this.locator.url,\n      cachedData.query !== this.locator.query,\n      !shallowEqual(cachedData.headers, this.locator.headers),\n      cachedData.body !== this.locator.body,\n    ];\n\n    return diffs.some((diff) => diff);\n  }\n\n  /**\n   * Get object to store in cache.\n   *\n   * @internal\n   */\n  getCacheData() {\n    return {\n      method: this.locator.method,\n      url: this.locator.url,\n      query: this.locator.query,\n      headers: this.locator.headers,\n      body: this.locator.body,\n    };\n  }\n\n  toObject() {\n    return {\n      scriptId: this.scriptId,\n      caller: this.caller,\n      locator: this.locator,\n      cache: this.cache,\n    };\n  }\n}\n"],"mappings":"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"}