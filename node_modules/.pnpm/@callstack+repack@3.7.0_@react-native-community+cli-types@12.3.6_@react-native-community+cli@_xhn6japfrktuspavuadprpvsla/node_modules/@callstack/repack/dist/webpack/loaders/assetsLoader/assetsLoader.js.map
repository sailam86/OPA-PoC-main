{"version":3,"file":"assetsLoader.js","names":["raw","testXml","testMP4","testImages","testFonts","repackAssetsLoader","cacheable","callback","async","logger","getLogger","rootContext","debug","resourcePath","options","getOptions","pathSeparatorRegexp","RegExp","path","sep","resourceAbsoluteDirname","dirname","resourceDirname","relative","replace","resourceExtensionType","extname","suffixPattern","platform","resourceFilename","basename","resourceNormalizedFilename","length","toLowerCase","assetsDirname","remoteAssetsDirname","files","getFilesInDirectory","fs","scales","AssetResolver","collectScales","scalableAssetExtensions","name","type","scaleKeys","Object","keys","sort","a","b","getScaleNumber","scaleKey","filenameWithScale","join","addDependency","assets","Promise","all","map","content","readFile","destination","devServerEnabled","remote","enabled","test","indexOf","Error","filename","scale","asset","inline","inlineAssets","emitFile","convertToRemoteAssets","remotePublicPath","publicPath","extractAssets","error"],"sources":["../../../../src/webpack/loaders/assetsLoader/assetsLoader.ts"],"sourcesContent":["import path from 'path';\nimport type { LoaderContext } from 'loader-utils';\nimport { AssetResolver } from '../../plugins/AssetsResolverPlugin/AssetResolver';\nimport { getOptions } from './options';\nimport { extractAssets } from './extractAssets';\nimport { inlineAssets } from './inlineAssets';\nimport { convertToRemoteAssets } from './convertToRemoteAssets';\nimport { getFilesInDirectory, getScaleNumber, readFile } from './utils';\nimport type { Asset } from './types';\n\nexport const raw = true;\n\nconst testXml = /\\.(xml)$/;\nconst testMP4 = /\\.(mp4)$/;\nconst testImages = /\\.(png|jpg|gif|webp)$/;\nconst testFonts = /\\.(ttf|otf|ttc)$/;\n\nexport default async function repackAssetsLoader(this: LoaderContext) {\n  this.cacheable();\n\n  const callback = this.async();\n  const logger = this.getLogger('repackAssetsLoader');\n  const rootContext = this.rootContext;\n\n  logger.debug(`Processing asset ${this.resourcePath}`);\n\n  try {\n    const options = getOptions(this);\n    const pathSeparatorRegexp = new RegExp(`\\\\${path.sep}`, 'g');\n    const resourcePath = this.resourcePath;\n    const resourceAbsoluteDirname = path.dirname(resourcePath);\n    // Relative path to rootContext without any ../ due to https://github.com/callstack/haul/issues/474\n    // Assets from from outside of rootContext, should still be placed inside bundle output directory.\n    // Example:\n    //   resourcePath    = <abs>/monorepo/node_modules/my-module/image.png\n    //   dirname         = <abs>/monorepo/node_modules/my-module\n    //   rootContext     = <abs>/monorepo/packages/my-app/\n    //   resourceDirname = ../../node_modules/my-module (original)\n    // So when we calculate destination for the asset for iOS (assetsDirname + resourceDirname + filename),\n    // it will end up outside of `assets` directory, so we have to make sure it's:\n    //   resourceDirname = node_modules/my-module (tweaked)\n    const resourceDirname = path\n      .relative(rootContext, resourceAbsoluteDirname)\n      .replace(new RegExp(`^[\\\\.\\\\${path.sep}]+`), '');\n    const resourceExtensionType = path.extname(resourcePath).replace(/^\\./, '');\n    const suffixPattern = `(@\\\\d+(\\\\.\\\\d+)?x)?(\\\\.(${options.platform}|native))?\\\\.${resourceExtensionType}$`;\n    const resourceFilename = path\n      .basename(resourcePath)\n      .replace(new RegExp(suffixPattern), '');\n    // Name with embedded resourceDirname eg `node_modules_reactnative_libraries_newappscreen_components_logo.png`\n    const resourceNormalizedFilename = `${(resourceDirname.length === 0\n      ? resourceFilename\n      : `${resourceDirname.replace(\n          pathSeparatorRegexp,\n          '_'\n        )}_${resourceFilename}`\n    )\n      .toLowerCase()\n      .replace(/[^a-z0-9_]/g, '')}.${resourceExtensionType}`;\n\n    const assetsDirname = 'assets';\n    const remoteAssetsDirname = 'remote-assets';\n\n    const files = await getFilesInDirectory(resourceAbsoluteDirname, this.fs);\n    const scales = AssetResolver.collectScales(\n      options.scalableAssetExtensions,\n      files,\n      {\n        name: resourceFilename,\n        type: resourceExtensionType,\n        platform: options.platform,\n      }\n    );\n\n    const scaleKeys = Object.keys(scales).sort(\n      (a, b) => getScaleNumber(a) - getScaleNumber(b)\n    );\n\n    for (const scaleKey of scaleKeys) {\n      const filenameWithScale = path.join(\n        resourceAbsoluteDirname,\n        scales[scaleKey].name\n      );\n      this.addDependency(filenameWithScale);\n    }\n\n    const assets = await Promise.all<Asset>(\n      scaleKeys.map(async (scaleKey) => {\n        const filenameWithScale = path.join(\n          resourceAbsoluteDirname,\n          scales[scaleKey].name\n        );\n\n        const content = await readFile(filenameWithScale, this.fs);\n\n        let destination;\n\n        if (\n          !options.devServerEnabled &&\n          !options.remote?.enabled &&\n          options.platform === 'android'\n        ) {\n          // found font family\n          if (\n            testXml.test(resourceNormalizedFilename) &&\n            content?.indexOf('font-family') !== -1\n          ) {\n            destination = 'font';\n          } else if (testFonts.test(resourceNormalizedFilename)) {\n            // font extensions\n            destination = 'font';\n          } else if (testMP4.test(resourceNormalizedFilename)) {\n            // video files extensions\n            destination = 'raw';\n          } else if (\n            testImages.test(resourceNormalizedFilename) ||\n            testXml.test(resourceNormalizedFilename)\n          ) {\n            // images extensions\n            switch (scaleKey) {\n              case '@0.75x':\n                destination = 'drawable-ldpi';\n                break;\n              case '@1x':\n                destination = 'drawable-mdpi';\n                break;\n              case '@1.5x':\n                destination = 'drawable-hdpi';\n                break;\n              case '@2x':\n                destination = 'drawable-xhdpi';\n                break;\n              case '@3x':\n                destination = 'drawable-xxhdpi';\n                break;\n              case '@4x':\n                destination = 'drawable-xxxhdpi';\n                break;\n              default:\n                throw new Error(\n                  `Unknown scale ${scaleKey} for ${filenameWithScale}`\n                );\n            }\n          } else {\n            // everything else is going to RAW\n            destination = 'raw';\n          }\n\n          destination = path.join(destination, resourceNormalizedFilename);\n        } else {\n          const name = `${resourceFilename}${\n            scaleKey === '@1x' ? '' : scaleKey\n          }.${resourceExtensionType}`;\n          destination = path.join(\n            options.remote?.enabled ? remoteAssetsDirname : '',\n            assetsDirname,\n            resourceDirname,\n            name\n          );\n        }\n\n        return {\n          filename: destination,\n          content,\n          scaleKey,\n          scale: getScaleNumber(scaleKey),\n        };\n      })\n    );\n\n    logger.debug(`Resolved request ${this.resourcePath}`, {\n      platform: options.platform,\n      rootContext,\n      resourceNormalizedFilename,\n      resourceFilename,\n      resourceDirname,\n      resourceAbsoluteDirname,\n      resourceExtensionType,\n      scales,\n      assets: assets.map((asset) => ({\n        ...asset,\n        content: `size=${asset.content?.length} type=${typeof asset.content}`,\n      })),\n    });\n\n    if (options.inline) {\n      logger.debug(`Inlining assets for request ${resourcePath}`);\n      callback?.(\n        null,\n        inlineAssets({ assets, resourcePath, resourceFilename, suffixPattern })\n      );\n    } else {\n      for (const asset of assets) {\n        const { filename, content } = asset;\n        logger.debug(`Emitting asset ${filename} for request ${resourcePath}`);\n\n        // Assets are emitted relatively to `output.path`.\n        this.emitFile(filename, content ?? '');\n      }\n\n      if (options.remote?.enabled) {\n        callback?.(\n          null,\n          convertToRemoteAssets({\n            assets,\n            assetsDirname,\n            remotePublicPath: options.remote.publicPath,\n            resourceDirname,\n            resourceExtensionType,\n            resourceFilename,\n            resourcePath,\n            suffixPattern,\n            pathSeparatorRegexp,\n          })\n        );\n      } else {\n        callback?.(\n          null,\n          await extractAssets(\n            {\n              resourcePath,\n              resourceDirname,\n              resourceFilename,\n              resourceExtensionType,\n              assets,\n              suffixPattern,\n              assetsDirname,\n              pathSeparatorRegexp,\n              publicPath: options.publicPath,\n              devServerEnabled: options.devServerEnabled,\n            },\n            logger\n          )\n        );\n      }\n    }\n  } catch (error) {\n    callback?.(error as Error);\n  }\n}\n"],"mappings":"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"}