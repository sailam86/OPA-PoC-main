{"version":3,"file":"RepackTargetPlugin.js","names":["RepackTargetPlugin","constructor","config","apply","compiler","globalObject","options","target","output","chunkLoading","chunkFormat","webpack","BannerPlugin","raw","entryOnly","banner","Template","asString","NormalModuleReplacementPlugin","resource","request","require","resolve","context","path","dirname","createData","hooks","compilation","tap","additionalTreeRuntimeRequirements","chunk","runtimeRequirements","add","RuntimeGlobals","startupOnlyAfter","addRuntimeModule","RepackInitRuntimeModule","chunkId","id","undefined","chunkLoadingGlobal","hmrEnabled","mode","hmr","runtimeRequirementInTree","for","loadScript","RepackLoadScriptRuntimeModule"],"sources":["../../../../src/webpack/plugins/RepackTargetPlugin/RepackTargetPlugin.ts"],"sourcesContent":["import path from 'path';\nimport webpack from 'webpack';\nimport type { DevServerOptions, WebpackPlugin } from '../../../types';\nimport { RepackInitRuntimeModule } from './runtime/RepackInitRuntimeModule';\nimport { RepackLoadScriptRuntimeModule } from './runtime/RepackLoadScriptRuntimeModule';\n\n/**\n * {@link RepackTargetPlugin} configuration options.\n */\nexport interface RepackTargetPluginConfig\n  extends Pick<DevServerOptions, 'hmr'> {}\n\n/**\n * Plugin for tweaking the JavaScript runtime code to account for React Native environment.\n *\n * Globally available APIs differ with React Native and other target's like Web, so there are some\n * tweaks necessary to make the final bundle runnable inside React Native's JavaScript VM.\n *\n * @category Webpack Plugin\n */\nexport class RepackTargetPlugin implements WebpackPlugin {\n  /**\n   * Constructs new `RepackTargetPlugin`.\n   *\n   * @param config Plugin configuration options.\n   */\n  constructor(private config?: RepackTargetPluginConfig) {}\n\n  /**\n   * Apply the plugin.\n   *\n   * @param compiler Webpack compiler instance.\n   */\n  apply(compiler: webpack.Compiler) {\n    const globalObject = 'self';\n    compiler.options.target = false;\n    compiler.options.output.chunkLoading = 'jsonp';\n    compiler.options.output.chunkFormat = 'array-push';\n    compiler.options.output.globalObject = globalObject;\n\n    // Normalize global object.\n    new webpack.BannerPlugin({\n      raw: true,\n      entryOnly: true,\n      banner: webpack.Template.asString([\n        `/******/ var ${globalObject} = ${globalObject} || this || new Function(\"return this\")() || ({}); // repackGlobal'`,\n        '/******/',\n      ]),\n    }).apply(compiler);\n\n    // Replace React Native's HMRClient.js with custom Webpack-powered DevServerClient.\n    new webpack.NormalModuleReplacementPlugin(\n      /react-native([/\\\\]+)Libraries([/\\\\]+)Utilities([/\\\\]+)HMRClient\\.js$/,\n      function (resource) {\n        const request = require.resolve('../../../modules/DevServerClient');\n        const context = path.dirname(request);\n        resource.request = request;\n        resource.context = context;\n        resource.createData.resource = request;\n        resource.createData.context = context;\n      }\n    ).apply(compiler);\n\n    compiler.hooks.compilation.tap('RepackTargetPlugin', (compilation) => {\n      compilation.hooks.additionalTreeRuntimeRequirements.tap(\n        'RepackTargetPlugin',\n        (chunk, runtimeRequirements) => {\n          runtimeRequirements.add(webpack.RuntimeGlobals.startupOnlyAfter);\n\n          // Add code initialize Re.Pack's runtime logic.\n          compilation.addRuntimeModule(\n            chunk,\n            new RepackInitRuntimeModule({\n              chunkId: chunk.id ?? undefined,\n              globalObject,\n              chunkLoadingGlobal: compiler.options.output.chunkLoadingGlobal!,\n              hmrEnabled:\n                compilation.options.mode === 'development' && this.config?.hmr,\n            })\n          );\n        }\n      );\n\n      // Overwrite Webpack's default load script runtime code with Re.Pack's implementation\n      // specific to React Native.\n      compilation.hooks.runtimeRequirementInTree\n        .for(webpack.RuntimeGlobals.loadScript)\n        .tap('RepackTargetPlugin', (chunk) => {\n          compilation.addRuntimeModule(\n            chunk,\n            new RepackLoadScriptRuntimeModule(chunk.id ?? undefined)\n          );\n\n          // Return `true` to make sure Webpack's default load script runtime is not added.\n          return true;\n        });\n    });\n  }\n}\n"],"mappings":";;;;;;;AAAA;;AACA;;AAEA;;AACA;;;;AAQA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,MAAMA,kBAAN,CAAkD;EACvD;AACF;AACA;AACA;AACA;EACEC,WAAW,CAASC,MAAT,EAA4C;IAAA,KAAnCA,MAAmC,GAAnCA,MAAmC;EAAE;EAEzD;AACF;AACA;AACA;AACA;;;EACEC,KAAK,CAACC,QAAD,EAA6B;IAChC,MAAMC,YAAY,GAAG,MAArB;IACAD,QAAQ,CAACE,OAAT,CAAiBC,MAAjB,GAA0B,KAA1B;IACAH,QAAQ,CAACE,OAAT,CAAiBE,MAAjB,CAAwBC,YAAxB,GAAuC,OAAvC;IACAL,QAAQ,CAACE,OAAT,CAAiBE,MAAjB,CAAwBE,WAAxB,GAAsC,YAAtC;IACAN,QAAQ,CAACE,OAAT,CAAiBE,MAAjB,CAAwBH,YAAxB,GAAuCA,YAAvC,CALgC,CAOhC;;IACA,IAAIM,gBAAA,CAAQC,YAAZ,CAAyB;MACvBC,GAAG,EAAE,IADkB;MAEvBC,SAAS,EAAE,IAFY;MAGvBC,MAAM,EAAEJ,gBAAA,CAAQK,QAAR,CAAiBC,QAAjB,CAA0B,CAC/B,gBAAeZ,YAAa,MAAKA,YAAa,qEADf,EAEhC,UAFgC,CAA1B;IAHe,CAAzB,EAOGF,KAPH,CAOSC,QAPT,EARgC,CAiBhC;;IACA,IAAIO,gBAAA,CAAQO,6BAAZ,CACE,sEADF,EAEE,UAAUC,QAAV,EAAoB;MAClB,MAAMC,OAAO,GAAGC,OAAO,CAACC,OAAR,CAAgB,kCAAhB,CAAhB;;MACA,MAAMC,OAAO,GAAGC,aAAA,CAAKC,OAAL,CAAaL,OAAb,CAAhB;;MACAD,QAAQ,CAACC,OAAT,GAAmBA,OAAnB;MACAD,QAAQ,CAACI,OAAT,GAAmBA,OAAnB;MACAJ,QAAQ,CAACO,UAAT,CAAoBP,QAApB,GAA+BC,OAA/B;MACAD,QAAQ,CAACO,UAAT,CAAoBH,OAApB,GAA8BA,OAA9B;IACD,CATH,EAUEpB,KAVF,CAUQC,QAVR;IAYAA,QAAQ,CAACuB,KAAT,CAAeC,WAAf,CAA2BC,GAA3B,CAA+B,oBAA/B,EAAsDD,WAAD,IAAiB;MACpEA,WAAW,CAACD,KAAZ,CAAkBG,iCAAlB,CAAoDD,GAApD,CACE,oBADF,EAEE,CAACE,KAAD,EAAQC,mBAAR,KAAgC;QAAA;;QAC9BA,mBAAmB,CAACC,GAApB,CAAwBtB,gBAAA,CAAQuB,cAAR,CAAuBC,gBAA/C,EAD8B,CAG9B;;QACAP,WAAW,CAACQ,gBAAZ,CACEL,KADF,EAEE,IAAIM,gDAAJ,CAA4B;UAC1BC,OAAO,EAAEP,KAAK,CAACQ,EAAN,IAAYC,SADK;UAE1BnC,YAF0B;UAG1BoC,kBAAkB,EAAErC,QAAQ,CAACE,OAAT,CAAiBE,MAAjB,CAAwBiC,kBAHlB;UAI1BC,UAAU,EACRd,WAAW,CAACtB,OAAZ,CAAoBqC,IAApB,KAA6B,aAA7B,qBAA8C,KAAKzC,MAAnD,iDAA8C,aAAa0C,GAA3D;QALwB,CAA5B,CAFF;MAUD,CAhBH,EADoE,CAoBpE;MACA;;MACAhB,WAAW,CAACD,KAAZ,CAAkBkB,wBAAlB,CACGC,GADH,CACOnC,gBAAA,CAAQuB,cAAR,CAAuBa,UAD9B,EAEGlB,GAFH,CAEO,oBAFP,EAE8BE,KAAD,IAAW;QACpCH,WAAW,CAACQ,gBAAZ,CACEL,KADF,EAEE,IAAIiB,4DAAJ,CAAkCjB,KAAK,CAACQ,EAAN,IAAYC,SAA9C,CAFF,EADoC,CAMpC;;QACA,OAAO,IAAP;MACD,CAVH;IAWD,CAjCD;EAkCD;;AA7EsD"}