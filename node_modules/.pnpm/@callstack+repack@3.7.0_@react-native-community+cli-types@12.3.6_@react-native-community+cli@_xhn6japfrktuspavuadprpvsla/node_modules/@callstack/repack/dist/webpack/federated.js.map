{"version":3,"file":"federated.js","names":["SHARED_REACT","singleton","eager","SHARED_REACT_NATIVE","createRemote","remote","remoteName","url","split","includes","Error","containerUrl","undefined","chunksUrl","URL","href","defaultResolver","dedent","Federated"],"sources":["../../src/webpack/federated.ts"],"sourcesContent":["import { URL } from 'url';\nimport dedent from 'dedent';\n\n/**\n * Namespace for utilities for Module Federation.\n */\nexport namespace Federated {\n  /**\n   * Predefined options for shared `react` dependency.\n   *\n   * @example Basic example.\n   * ```js\n   * import * as Repack from '@callstack/repack';\n   *\n   * new Repack.plugins.ModuleFederationPlugin({\n   *   // ...\n   *   shared: {\n   *     react: Repack.Federated.SHARED_REACT,\n   *   }\n   * });\n   * ```\n   *\n   * @example Example with spread and additional options.\n   * ```js\n   * import * as Repack from '@callstack/repack';\n   *\n   * new Repack.plugins.ModuleFederationPlugin({\n   *   // ...\n   *   shared: {\n   *     react: {\n   *       ...Repack.Federated.SHARED_REACT,\n   *       // additional options\n   *     }\n   *   }\n   * });\n   * ```\n   */\n  export const SHARED_REACT = {\n    singleton: true,\n    eager: true,\n  };\n\n  /**\n   * Predefined options for shared `react-native` dependency.\n   *\n   * @example Basic example.\n   * ```js\n   * import * as React from 'repack';\n   *\n   * new Repack.plugins.ModuleFederationPlugin({\n   *   // ...\n   *   shared: {\n   *     'react-native': Repack.Federated.SHARED_REACT,\n   *   }\n   * });\n   * ```\n   *\n   * @example Example with spread and additional options.\n   * ```js\n   * import * as React from 'repack';\n   *\n   * new Repack.plugins.ModuleFederationPlugin({\n   *   // ...\n   *   shared: {\n   *     'react-native': {\n   *       ...Repack.Federated.SHARED_REACT_NATIVE,\n   *       // additional options\n   *     }\n   *   }\n   * });\n   * ```\n   */\n  export const SHARED_REACT_NATIVE = {\n    singleton: true,\n    eager: true,\n  };\n\n  /**\n   * Creates JavaScript loading code for the given Module Federation remote\n   * allowing to import that remote without creating an async boundary, but with\n   * simple import statement, eg: `import MyComponent from 'my-remote/MyComponent';`.\n   *\n   * `Federated.createRemote` adds a default resolver for container and it's chunks\n   * with priority `0`, if you provide URL after the `@`.\n   * If `dynamic` (eg `module1@dynamic`) is provided, no default resolver will be added.\n   *\n   * __This function should be used only when using `webpack.container.ModuleFederationPlugin`.__\n   * For `Repack.plugins.ModuleFederationPlugin`, `Federated.createRemote` is used under the hood.\n   *\n   * Remote container will be evaluated only once. If you import module from the same container twice,\n   * the container will be loaded and evaluated only on the first import.\n   *\n   * @param remote Remote name with URL or `dynamic` separated by `@`.\n   * @returns A JavaScript loading code the the given remote.\n   *\n   * @example\n   * ```ts\n   * import webpack from 'webpack';\n   * import * as Repack from '@callstack/repack';\n   *\n   * export default (env) => {\n   *   return {\n   *     plugins: [\n   *       new webpack.container.ModuleFederationPlugin({\n   *         remotes: {\n   *           app1: Repack.Federated.createRemote('app1@dynamic'),\n   *           app2: Repack.Federated.createRemote('app2@https://example.com/app2.container.bundle'),\n   *         },\n   *       }),\n   *     ],\n   *   };\n   * };\n   * ```\n   */\n  export function createRemote(remote: string) {\n    const [remoteName, url] = remote.split('@');\n\n    if (!url) {\n      if (remote.includes('@')) {\n        throw new Error(\n          'Missing URL after @. Use `dynamic` or provide full URL to container bundle.'\n        );\n      } else {\n        throw new Error(\n          'Remote must provide @ with either full URL to container bundle or `dynamic`.'\n        );\n      }\n    }\n\n    const containerUrl = url === 'dynamic' ? undefined : url;\n    const chunksUrl =\n      url === 'dynamic' ? undefined : new URL('[name][ext]', url).href;\n\n    const defaultResolver = containerUrl\n      ? dedent`\n          scriptManager.addResolver(function (scriptId, caller) {\n            if (scriptId === '${remoteName}') {\n              return {\n                url: '${containerUrl}',\n              };\n            }\n          }, { priority: 0 });\n\n          scriptManager.addResolver(function (scriptId, caller) {\n            if (caller === '${remoteName}') {\n              return {\n                url: (webpackContext) => '${chunksUrl}'.replace('[name][ext]', webpackContext.u(scriptId)),\n              };\n            }\n          }, { priority: 0 });\n        `\n      : '';\n\n    return dedent`promise new Promise((resolve, reject) => {\n      function resolveRemote() {\n        resolve({\n          get: (request) => {\n            return self.${remoteName}.get(request);\n          },\n          init: (arg) => {\n            if (!self.${remoteName}.__isInitialized) {\n              try {\n                self.${remoteName}.__isInitialized = true;\n                return self.${remoteName}.init(arg);\n              } catch (e) {\n                console.log('[Repack/Federated] Remote container ${remoteName} already initialized.');\n              }\n            }\n          }\n        });\n      }\n\n      if (self.${remoteName}) {\n        return resolveRemote();\n      }\n      var scriptManager = __webpack_require__.repack.shared.scriptManager;\n\n      ${defaultResolver}\n\n      scriptManager\n        .loadScript('${remoteName}', undefined, __webpack_require__)\n        .then(function() {\n          resolveRemote();\n        })\n        .catch(function(reason) {\n          reject(reason);\n        });\n    })`;\n  }\n}\n"],"mappings":";;;;;;;AAAA;;AACA;;;;AAEA;AACA;AACA;;;;;EAgCS,MAAMA,YAAY,6BAAG;IAC1BC,SAAS,EAAE,IADe;IAE1BC,KAAK,EAAE;EAFmB,CAArB;EAmCA,MAAMC,mBAAmB,oCAAG;IACjCF,SAAS,EAAE,IADsB;IAEjCC,KAAK,EAAE;EAF0B,CAA5B;;EA0CA,SAASE,YAAT,CAAsBC,MAAtB,EAAsC;IAC3C,MAAM,CAACC,UAAD,EAAaC,GAAb,IAAoBF,MAAM,CAACG,KAAP,CAAa,GAAb,CAA1B;;IAEA,IAAI,CAACD,GAAL,EAAU;MACR,IAAIF,MAAM,CAACI,QAAP,CAAgB,GAAhB,CAAJ,EAA0B;QACxB,MAAM,IAAIC,KAAJ,CACJ,6EADI,CAAN;MAGD,CAJD,MAIO;QACL,MAAM,IAAIA,KAAJ,CACJ,8EADI,CAAN;MAGD;IACF;;IAED,MAAMC,YAAY,GAAGJ,GAAG,KAAK,SAAR,GAAoBK,SAApB,GAAgCL,GAArD;IACA,MAAMM,SAAS,GACbN,GAAG,KAAK,SAAR,GAAoBK,SAApB,GAAgC,IAAIE,QAAJ,CAAQ,aAAR,EAAuBP,GAAvB,EAA4BQ,IAD9D;IAGA,MAAMC,eAAe,GAAGL,YAAY,GAChC,IAAAM,eAAA,CAAO;AACf;AACA,gCAAgCX,UAAW;AAC3C;AACA,wBAAwBK,YAAa;AACrC;AACA;AACA;AACA;AACA;AACA,8BAA8BL,UAAW;AACzC;AACA,4CAA4CO,SAAU;AACtD;AACA;AACA;AACA,SAjBwC,GAkBhC,EAlBJ;IAoBA,OAAO,IAAAI,eAAA,CAAO;AAClB;AACA;AACA;AACA,0BAA0BX,UAAW;AACrC;AACA;AACA,wBAAwBA,UAAW;AACnC;AACA,uBAAuBA,UAAW;AAClC,8BAA8BA,UAAW;AACzC;AACA,mEAAmEA,UAAW;AAC9E;AACA;AACA;AACA;AACA;AACA;AACA,iBAAiBA,UAAW;AAC5B;AACA;AACA;AACA;AACA,QAAQU,eAAgB;AACxB;AACA;AACA,uBAAuBV,UAAW;AAClC;AACA;AACA;AACA;AACA;AACA;AACA,OAlCI;EAmCD;;;GAtLcY,S,yBAAAA,S"}