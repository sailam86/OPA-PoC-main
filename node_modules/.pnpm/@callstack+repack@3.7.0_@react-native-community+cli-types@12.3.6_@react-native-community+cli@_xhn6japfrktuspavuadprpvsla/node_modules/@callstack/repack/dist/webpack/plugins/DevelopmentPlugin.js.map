{"version":3,"file":"DevelopmentPlugin.js","names":["DevelopmentPlugin","constructor","config","apply","compiler","logger","getInfrastructureLogger","devServer","webpack","DefinePlugin","__PUBLIC_PORT__","JSON","stringify","port","__PLATFORM__","platform","hmr","HotModuleReplacementPlugin","ReactRefreshPlugin","overlay","getAdjustedEntry","entry","refreshEntryPath","key","import","entryImports","hmrClientIndex","findIndex","value","test","splice","reactRefreshEntryPath","require","resolve","options","getEntry","hooks","make","tapAsync","compilation","callback","globalEntryDeps","globalEntry","dependencies","refreshEntryIndex","request","experiments","lazyCompilation","entries","initialize","tap","error","ProvidePlugin","EventSource"],"sources":["../../../src/webpack/plugins/DevelopmentPlugin.ts"],"sourcesContent":["import webpack from 'webpack';\nimport ReactRefreshPlugin from '@pmmmwh/react-refresh-webpack-plugin';\nimport type { DevServerOptions, WebpackPlugin } from '../../types';\n\ntype ExtractEntryStaticNormalized<E> = E extends () => Promise<infer U>\n  ? U\n  : E extends { [key: string]: any }\n  ? E\n  : never;\n\ntype EntryStaticNormalized =\n  ExtractEntryStaticNormalized<webpack.EntryNormalized>;\n\ntype ModuleDependency = webpack.dependencies.ModuleDependency;\n/**\n * {@link DevelopmentPlugin} configuration options.\n */\nexport interface DevelopmentPluginConfig {\n  platform: string;\n  devServer?: DevServerOptions;\n}\n\n/**\n * Class for running development server that handles serving the built bundle, all assets as well as\n * providing Hot Module Replacement functionality.\n *\n * @category Webpack Plugin\n */\nexport class DevelopmentPlugin implements WebpackPlugin {\n  /**\n   * Constructs new `DevelopmentPlugin`.\n   *\n   * @param config Plugin configuration options.\n   */\n  constructor(private config?: DevelopmentPluginConfig) {}\n\n  /**\n   * Apply the plugin.\n   *\n   * @param compiler Webpack compiler instance.\n   */\n  apply(compiler: webpack.Compiler) {\n    const logger = compiler.getInfrastructureLogger('DevelopmentPlugin');\n\n    if (!this.config?.devServer) {\n      return;\n    }\n\n    new webpack.DefinePlugin({\n      __PUBLIC_PORT__: JSON.stringify(this.config.devServer.port),\n      __PLATFORM__: JSON.stringify(this.config.platform),\n    }).apply(compiler);\n\n    if (this.config?.devServer.hmr) {\n      new webpack.HotModuleReplacementPlugin().apply(compiler);\n      new ReactRefreshPlugin({\n        overlay: false,\n      }).apply(compiler);\n\n      // To avoid the problem from https://github.com/facebook/react/issues/20377\n      // we need to move React Refresh entry that `ReactRefreshPlugin` injects to evaluate right\n      // before the `WebpackHMRClient` and after `InitializeCore` which sets up React DevTools.\n      // Thanks to that the initialization order is correct:\n      // 0. Polyfills\n      // 1. `InitilizeCore` -> React DevTools\n      // 2. Rect Refresh Entry\n      // 3. `WebpackHMRClient`\n      // NOTE: This needs to be done before compilation begins\n      const getAdjustedEntry = (\n        entry: EntryStaticNormalized,\n        refreshEntryPath: string\n      ) => {\n        for (const key in entry) {\n          const { import: entryImports = [] } = entry[key];\n          const hmrClientIndex = entryImports.findIndex((value) =>\n            /WebpackHMRClient\\.js/.test(value)\n          );\n          if (hmrClientIndex >= 0) {\n            entryImports.splice(hmrClientIndex, 0, refreshEntryPath);\n            entry[key].import = entryImports;\n          }\n        }\n        return entry;\n      };\n\n      // To modify the entry before compilation\n      // we need to obtain the path to ReactRefreshEntry.js manually\n      const reactRefreshEntryPath = require.resolve(\n        '@pmmmwh/react-refresh-webpack-plugin/client/ReactRefreshEntry.js'\n      );\n\n      if (typeof compiler.options.entry !== 'function') {\n        compiler.options.entry = getAdjustedEntry(\n          compiler.options.entry,\n          reactRefreshEntryPath\n        );\n      } else {\n        const getEntry = compiler.options.entry;\n        compiler.options.entry = async () => {\n          const entry = await getEntry();\n          return getAdjustedEntry(entry, reactRefreshEntryPath);\n        };\n      }\n\n      compiler.hooks.make.tapAsync(\n        'RemoveOriginalReactRefreshEntry',\n        (compilation, callback) => {\n          const globalEntryDeps = compilation.globalEntry\n            .dependencies as ModuleDependency[];\n          const refreshEntryIndex = globalEntryDeps.findIndex((value) =>\n            /ReactRefreshEntry\\.js/.test(value.request)\n          );\n          if (refreshEntryIndex >= 0) {\n            globalEntryDeps.splice(refreshEntryIndex, 1);\n          }\n          callback(null);\n        }\n      );\n    }\n\n    if (compiler.options.experiments?.lazyCompilation) {\n      if (compiler.options.experiments.lazyCompilation.entries !== false) {\n        compiler.hooks.initialize.tap('DevelopmentPlugin', () => {\n          logger.error(\n            'You have enabled lazyCompilation for entrypoints which is not supported. ' +\n              'Lazy compilation is supported only for dynamic imports. ' +\n              'You can fix this by adding { entries: false } to experiments.lazyCompilation configuration object inside webpack.config.'\n          );\n        });\n      }\n\n      try {\n        require.resolve('react-native-event-source');\n      } catch (error) {\n        compiler.hooks.initialize.tap('DevelopmentPlugin', () => {\n          logger.error(\n            \"You have enabled lazyCompilation but 'react-native-event-source' was not found in your devDependencies. \" +\n              'Please install it via your package manager and try again.'\n          );\n        });\n      }\n\n      new webpack.ProvidePlugin({\n        EventSource: ['react-native-event-source', 'default'],\n      }).apply(compiler);\n    }\n  }\n}\n"],"mappings":"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"}