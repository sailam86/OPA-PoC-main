{"version":3,"file":"webpackWorker.js","names":["main","cliOptions","webpackEnvOptions","getWebpackEnvOptions","webpackConfig","loadWebpackConfig","config","webpackConfigPath","watchOptions","plugins","concat","webpack","ProgressPlugin","_1","_2","message","completed","total","exec","undefined","parentPort","postMessage","event","parseInt","compiler","fileSystem","memfs","createFsFromVolume","Volume","outputFileSystem","hooks","watchRun","tap","invalid","done","stats","outputDirectory","compilation","outputOptions","path","assets","getAssets","map","asset","data","readFileSync","join","name","filename","info","toJson","all","cached","children","modules","timings","hash","errors","warnings","buffer","watch","error","workerData","catch","process","exit"],"sources":["../../src/webpack/webpackWorker.ts"],"sourcesContent":["import { workerData, parentPort } from 'worker_threads';\nimport path from 'path';\nimport webpack from 'webpack';\nimport memfs from 'memfs';\nimport type { CliOptions } from '../types';\nimport { getWebpackEnvOptions } from './utils';\nimport { loadWebpackConfig } from './loadWebpackConfig';\n\nasync function main(cliOptions: CliOptions) {\n  const webpackEnvOptions = getWebpackEnvOptions(cliOptions);\n  const webpackConfig = await loadWebpackConfig(\n    cliOptions.config.webpackConfigPath,\n    webpackEnvOptions\n  );\n  const watchOptions = webpackConfig.watchOptions ?? {};\n\n  webpackConfig.plugins = (webpackConfig.plugins ?? []).concat(\n    new webpack.ProgressPlugin((_1, _2, message) => {\n      const [, completed, total] = /(\\d+)\\/(\\d+) modules/.exec(message) ?? [];\n      if (completed !== undefined && total !== undefined) {\n        parentPort?.postMessage({\n          event: 'progress',\n          completed: parseInt(completed, 10),\n          total: parseInt(total, 10),\n          message,\n        });\n      }\n    })\n  );\n\n  const compiler = webpack(webpackConfig);\n\n  const fileSystem = memfs.createFsFromVolume(new memfs.Volume());\n  compiler.outputFileSystem = fileSystem;\n\n  compiler.hooks.watchRun.tap('webpackWorker', () => {\n    parentPort?.postMessage({ event: 'watchRun' });\n  });\n\n  compiler.hooks.invalid.tap('webpackWorker', () => {\n    parentPort?.postMessage({ event: 'invalid' });\n  });\n\n  compiler.hooks.done.tap('webpackWorker', (stats) => {\n    const outputDirectory = stats.compilation.outputOptions.path!;\n    const assets = stats.compilation.getAssets().map((asset) => {\n      const data = fileSystem.readFileSync(\n        path.join(outputDirectory, asset.name)\n      ) as Buffer;\n      return {\n        filename: asset.name,\n        data,\n        info: asset.info,\n      };\n    });\n    parentPort?.postMessage(\n      {\n        event: 'done',\n        assets,\n        stats: stats.toJson({\n          all: false,\n          cached: true,\n          children: true,\n          modules: true,\n          timings: true,\n          hash: true,\n          errors: true,\n          warnings: false,\n        }),\n      },\n      assets.map((asset) => asset.data.buffer)\n    );\n  });\n\n  compiler.watch(watchOptions, (error) => {\n    if (error) {\n      parentPort?.postMessage({ event: 'error', error });\n    }\n  });\n}\n\nmain(workerData).catch((error) => {\n  parentPort?.postMessage({ event: 'error', error });\n  process.exit(1);\n});\n"],"mappings":"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"}