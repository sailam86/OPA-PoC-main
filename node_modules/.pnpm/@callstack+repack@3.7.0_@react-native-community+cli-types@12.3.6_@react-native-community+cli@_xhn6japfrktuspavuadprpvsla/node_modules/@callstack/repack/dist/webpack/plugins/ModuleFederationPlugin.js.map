{"version":3,"file":"ModuleFederationPlugin.js","names":["ModuleFederationPlugin","constructor","config","reactNativeDeepImports","replaceRemotes","remote","startsWith","Federated","createRemote","Array","isArray","map","remoteItem","replaced","key","value","external","getDefaultSharedDependencies","react","SHARED_REACT","SHARED_REACT_NATIVE","adaptSharedDependencies","shared","sharedDependencyConfig","eager","singleton","requiredVersion","findSharedDependency","name","dependencies","find","item","Boolean","sharedReactNative","reactNativeEager","undefined","adjustedSharedDependencies","push","Object","assign","apply","compiler","remotes","sharedDependencies","container","exposes","filename","library","type","shareScope","remoteType","runtime"],"sources":["../../../src/webpack/plugins/ModuleFederationPlugin.ts"],"sourcesContent":["import { Compiler, container } from 'webpack';\nimport type { WebpackPlugin } from '../../types';\nimport { Federated } from '../federated';\n\ntype ModuleFederationPluginOptions =\n  typeof container.ModuleFederationPlugin extends {\n    new (options: infer O): InstanceType<\n      typeof container.ModuleFederationPlugin\n    >;\n  }\n    ? O\n    : never;\n\ntype ExtractObject<T> = T extends {}\n  ? T extends Array<any>\n    ? never\n    : T\n  : never;\n\ntype RemotesObject = ExtractObject<ModuleFederationPluginOptions['remotes']>;\n\ntype SharedDependencies = Exclude<\n  ModuleFederationPluginOptions['shared'],\n  undefined\n>;\n\ntype SharedObject = ExtractObject<SharedDependencies>;\n\ntype SharedConfig = SharedObject extends { [key: string]: infer U }\n  ? Exclude<U, string>\n  : never;\n\n/**\n * {@link ModuleFederationPlugin} configuration options.\n *\n * The fields and types are exactly the same as in `webpack.container.ModuleFederationPlugin`.\n *\n * You can check documentation for all supported options here: https://webpack.js.org/plugins/module-federation-plugin/\n */\nexport interface ModuleFederationPluginConfig\n  extends ModuleFederationPluginOptions {\n  /** Enable or disable adding React Native deep imports to shared dependencies */\n  reactNativeDeepImports?: boolean;\n}\n\n/**\n * Webpack plugin to configure Module Federation with platform differences\n * handled under the hood.\n *\n * Usually, you should use `Repack.plugin.ModuleFederationPlugin`\n * instead of `webpack.container.ModuleFederationPlugin`.\n *\n * `Repack.plugin.ModuleFederationPlugin` creates:\n * - default for `filename` option when `exposes` is defined\n * - default for `library` option when `exposes` is defined\n * - default for `shared` option with `react` and `react-native` dependencies\n * - converts `remotes` into `ScriptManager`-powered `promise new Promise` loaders\n *\n * You can overwrite all defaults by passing respective options.\n *\n * `remotes` will always be converted to ScriptManager`-powered `promise new Promise` loaders\n * using {@link Federated.createRemote}.\n *\n * @example Host example.\n * ```js\n * import * as Repack from '@callstack/repack';\n *\n * new Repack.plugins.ModuleFederationPlugin({\n *   name: 'host,\n * });\n * ```\n *\n * @example Host example with additional `shared` dependencies.\n * ```js\n * import * as Repack from '@callstack/repack';\n *\n * new Repack.plugins.ModuleFederationPlugin({\n *   name: 'host,\n *   shared: {\n *     react: Repack.Federated.SHARED_REACT,\n *     'react-native': Repack.Federated.SHARED_REACT,\n *     'react-native-reanimated': {\n *       singleton: true,\n *     },\n *   },\n * });\n * ```\n *\n * @example Container examples.\n * ```js\n * import * as Repack from '@callstack/repack';\n *\n * new Repack.plugins.ModuleFederationPlugin({\n *   name: 'app1',\n *   remotes: {\n *     module1: 'module1@https://example.com/module1.container.bundle',\n *   },\n * });\n *\n * new Repack.plugins.ModuleFederationPlugin({\n *   name: 'app2',\n *   remotes: {\n *     module1: 'module1@https://example.com/module1.container.bundle',\n *     module2: 'module1@dynamic',\n *   },\n * });\n * ```\n *\n * @category Webpack Plugin\n */\nexport class ModuleFederationPlugin implements WebpackPlugin {\n  constructor(private config: ModuleFederationPluginConfig) {\n    this.config.reactNativeDeepImports =\n      this.config.reactNativeDeepImports ?? true;\n  }\n\n  private replaceRemotes<T extends string | string[] | RemotesObject>(\n    remote: T\n  ): T {\n    if (typeof remote === 'string') {\n      return remote.startsWith('promise new Promise')\n        ? remote\n        : (Federated.createRemote(remote) as T);\n    }\n\n    if (Array.isArray(remote)) {\n      return remote.map((remoteItem) => this.replaceRemotes(remoteItem)) as T;\n    }\n\n    const replaced = {} as RemotesObject;\n    for (const key in remote as RemotesObject) {\n      const value = remote[key];\n      if (typeof value === 'string' || Array.isArray(value)) {\n        replaced[key] = this.replaceRemotes(value);\n      } else {\n        replaced[key] = {\n          ...value,\n          external: this.replaceRemotes(value.external),\n        };\n      }\n    }\n\n    return replaced as T;\n  }\n\n  private getDefaultSharedDependencies(): SharedObject {\n    return {\n      react: Federated.SHARED_REACT,\n      'react-native': Federated.SHARED_REACT_NATIVE,\n    };\n  }\n\n  /**\n   * As including 'react-native' as a shared dependency is not enough to support\n   * deep imports from 'react-native' (e.g. 'react-native/Libraries/Utilities/PixelRatio'),\n   * we need to add deep imports using an undocumented feature of ModuleFederationPlugin.\n   *\n   * When a dependency has a trailing slash, deep imports of that dependency will be correctly\n   * resolved by reaching out to the shared scope. This also ensures single instances of things\n   * like 'assetsRegistry'. Additionally, we mark every package from '@react-native' group as shared\n   * as well, as these are used by React Native too.\n   *\n   * Reference: https://stackoverflow.com/questions/65636979/wp5-module-federation-sharing-deep-imports\n   * Reference: https://github.com/webpack/webpack/blob/main/lib/sharing/resolveMatchedConfigs.js#L77-L79\n   *\n   * @param shared shared dependencies configuration from ModuleFederationPlugin\n   * @returns adjusted shared dependencies configuration\n   *\n   * @internal\n   */\n  private adaptSharedDependencies(\n    shared: SharedDependencies\n  ): SharedDependencies {\n    const sharedDependencyConfig = (eager?: boolean) => ({\n      singleton: true,\n      eager: eager ?? true,\n      requiredVersion: '*',\n    });\n\n    const findSharedDependency = (\n      name: string,\n      dependencies: SharedDependencies\n    ): SharedConfig | string | undefined => {\n      if (Array.isArray(dependencies)) {\n        return dependencies.find((item) =>\n          typeof item === 'string' ? item === name : Boolean(item[name])\n        );\n      } else {\n        return dependencies[name];\n      }\n    };\n\n    const sharedReactNative = findSharedDependency('react-native', shared);\n    const reactNativeEager =\n      typeof sharedReactNative === 'object'\n        ? sharedReactNative.eager\n        : undefined;\n\n    if (!this.config.reactNativeDeepImports || !sharedReactNative) {\n      return shared;\n    }\n\n    if (Array.isArray(shared)) {\n      const adjustedSharedDependencies = [...shared];\n      if (!findSharedDependency('react-native/', shared)) {\n        adjustedSharedDependencies.push({\n          'react-native/': sharedDependencyConfig(reactNativeEager),\n        });\n      }\n      if (!findSharedDependency('@react-native/', shared)) {\n        adjustedSharedDependencies.push({\n          '@react-native/': sharedDependencyConfig(reactNativeEager),\n        });\n      }\n      return adjustedSharedDependencies;\n    } else {\n      const adjustedSharedDependencies = { ...shared };\n      if (!findSharedDependency('react-native/', shared)) {\n        Object.assign(adjustedSharedDependencies, {\n          'react-native/': sharedDependencyConfig(reactNativeEager),\n        });\n      }\n      if (!findSharedDependency('@react-native/', shared)) {\n        Object.assign(adjustedSharedDependencies, {\n          '@react-native/': sharedDependencyConfig(reactNativeEager),\n        });\n      }\n      return adjustedSharedDependencies;\n    }\n  }\n\n  /**\n   * Apply the plugin.\n   *\n   * @param compiler Webpack compiler instance.\n   */\n  apply(compiler: Compiler) {\n    const remotes = Array.isArray(this.config.remotes)\n      ? this.config.remotes.map((remote) => this.replaceRemotes(remote))\n      : this.replaceRemotes(this.config.remotes ?? {});\n\n    const sharedDependencies = this.adaptSharedDependencies(\n      this.config.shared ?? this.getDefaultSharedDependencies()\n    );\n\n    new container.ModuleFederationPlugin({\n      exposes: this.config.exposes,\n      filename:\n        this.config.filename ?? this.config.exposes\n          ? `${this.config.name}.container.bundle`\n          : undefined,\n      library: this.config.exposes\n        ? {\n            name: this.config.name,\n            type: 'self',\n            ...this.config.library,\n          }\n        : undefined,\n      name: this.config.name,\n      shared: sharedDependencies,\n      shareScope: this.config.shareScope,\n      remotes,\n      remoteType: this.config.remoteType,\n      runtime: this.config.runtime,\n    }).apply(compiler);\n  }\n}\n"],"mappings":";;;;;;;AAAA;;AAEA;;AA2CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,MAAMA,sBAAN,CAAsD;EAC3DC,WAAW,CAASC,MAAT,EAA+C;IAAA,KAAtCA,MAAsC,GAAtCA,MAAsC;IACxD,KAAKA,MAAL,CAAYC,sBAAZ,GACE,KAAKD,MAAL,CAAYC,sBAAZ,IAAsC,IADxC;EAED;;EAEOC,cAAc,CACpBC,MADoB,EAEjB;IACH,IAAI,OAAOA,MAAP,KAAkB,QAAtB,EAAgC;MAC9B,OAAOA,MAAM,CAACC,UAAP,CAAkB,qBAAlB,IACHD,MADG,GAEFE,oBAAA,CAAUC,YAAV,CAAuBH,MAAvB,CAFL;IAGD;;IAED,IAAII,KAAK,CAACC,OAAN,CAAcL,MAAd,CAAJ,EAA2B;MACzB,OAAOA,MAAM,CAACM,GAAP,CAAYC,UAAD,IAAgB,KAAKR,cAAL,CAAoBQ,UAApB,CAA3B,CAAP;IACD;;IAED,MAAMC,QAAQ,GAAG,EAAjB;;IACA,KAAK,MAAMC,GAAX,IAAkBT,MAAlB,EAA2C;MACzC,MAAMU,KAAK,GAAGV,MAAM,CAACS,GAAD,CAApB;;MACA,IAAI,OAAOC,KAAP,KAAiB,QAAjB,IAA6BN,KAAK,CAACC,OAAN,CAAcK,KAAd,CAAjC,EAAuD;QACrDF,QAAQ,CAACC,GAAD,CAAR,GAAgB,KAAKV,cAAL,CAAoBW,KAApB,CAAhB;MACD,CAFD,MAEO;QACLF,QAAQ,CAACC,GAAD,CAAR,GAAgB,EACd,GAAGC,KADW;UAEdC,QAAQ,EAAE,KAAKZ,cAAL,CAAoBW,KAAK,CAACC,QAA1B;QAFI,CAAhB;MAID;IACF;;IAED,OAAOH,QAAP;EACD;;EAEOI,4BAA4B,GAAiB;IACnD,OAAO;MACLC,KAAK,EAAEX,oBAAA,CAAUY,YADZ;MAEL,gBAAgBZ,oBAAA,CAAUa;IAFrB,CAAP;EAID;EAED;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;EACUC,uBAAuB,CAC7BC,MAD6B,EAET;IACpB,MAAMC,sBAAsB,GAAIC,KAAD,KAAsB;MACnDC,SAAS,EAAE,IADwC;MAEnDD,KAAK,EAAEA,KAAK,IAAI,IAFmC;MAGnDE,eAAe,EAAE;IAHkC,CAAtB,CAA/B;;IAMA,MAAMC,oBAAoB,GAAG,CAC3BC,IAD2B,EAE3BC,YAF2B,KAGW;MACtC,IAAIpB,KAAK,CAACC,OAAN,CAAcmB,YAAd,CAAJ,EAAiC;QAC/B,OAAOA,YAAY,CAACC,IAAb,CAAmBC,IAAD,IACvB,OAAOA,IAAP,KAAgB,QAAhB,GAA2BA,IAAI,KAAKH,IAApC,GAA2CI,OAAO,CAACD,IAAI,CAACH,IAAD,CAAL,CAD7C,CAAP;MAGD,CAJD,MAIO;QACL,OAAOC,YAAY,CAACD,IAAD,CAAnB;MACD;IACF,CAXD;;IAaA,MAAMK,iBAAiB,GAAGN,oBAAoB,CAAC,cAAD,EAAiBL,MAAjB,CAA9C;IACA,MAAMY,gBAAgB,GACpB,OAAOD,iBAAP,KAA6B,QAA7B,GACIA,iBAAiB,CAACT,KADtB,GAEIW,SAHN;;IAKA,IAAI,CAAC,KAAKjC,MAAL,CAAYC,sBAAb,IAAuC,CAAC8B,iBAA5C,EAA+D;MAC7D,OAAOX,MAAP;IACD;;IAED,IAAIb,KAAK,CAACC,OAAN,CAAcY,MAAd,CAAJ,EAA2B;MACzB,MAAMc,0BAA0B,GAAG,CAAC,GAAGd,MAAJ,CAAnC;;MACA,IAAI,CAACK,oBAAoB,CAAC,eAAD,EAAkBL,MAAlB,CAAzB,EAAoD;QAClDc,0BAA0B,CAACC,IAA3B,CAAgC;UAC9B,iBAAiBd,sBAAsB,CAACW,gBAAD;QADT,CAAhC;MAGD;;MACD,IAAI,CAACP,oBAAoB,CAAC,gBAAD,EAAmBL,MAAnB,CAAzB,EAAqD;QACnDc,0BAA0B,CAACC,IAA3B,CAAgC;UAC9B,kBAAkBd,sBAAsB,CAACW,gBAAD;QADV,CAAhC;MAGD;;MACD,OAAOE,0BAAP;IACD,CAbD,MAaO;MACL,MAAMA,0BAA0B,GAAG,EAAE,GAAGd;MAAL,CAAnC;;MACA,IAAI,CAACK,oBAAoB,CAAC,eAAD,EAAkBL,MAAlB,CAAzB,EAAoD;QAClDgB,MAAM,CAACC,MAAP,CAAcH,0BAAd,EAA0C;UACxC,iBAAiBb,sBAAsB,CAACW,gBAAD;QADC,CAA1C;MAGD;;MACD,IAAI,CAACP,oBAAoB,CAAC,gBAAD,EAAmBL,MAAnB,CAAzB,EAAqD;QACnDgB,MAAM,CAACC,MAAP,CAAcH,0BAAd,EAA0C;UACxC,kBAAkBb,sBAAsB,CAACW,gBAAD;QADA,CAA1C;MAGD;;MACD,OAAOE,0BAAP;IACD;EACF;EAED;AACF;AACA;AACA;AACA;;;EACEI,KAAK,CAACC,QAAD,EAAqB;IACxB,MAAMC,OAAO,GAAGjC,KAAK,CAACC,OAAN,CAAc,KAAKR,MAAL,CAAYwC,OAA1B,IACZ,KAAKxC,MAAL,CAAYwC,OAAZ,CAAoB/B,GAApB,CAAyBN,MAAD,IAAY,KAAKD,cAAL,CAAoBC,MAApB,CAApC,CADY,GAEZ,KAAKD,cAAL,CAAoB,KAAKF,MAAL,CAAYwC,OAAZ,IAAuB,EAA3C,CAFJ;IAIA,MAAMC,kBAAkB,GAAG,KAAKtB,uBAAL,CACzB,KAAKnB,MAAL,CAAYoB,MAAZ,IAAsB,KAAKL,4BAAL,EADG,CAA3B;IAIA,IAAI2B,kBAAA,CAAU5C,sBAAd,CAAqC;MACnC6C,OAAO,EAAE,KAAK3C,MAAL,CAAY2C,OADc;MAEnCC,QAAQ,EACN,KAAK5C,MAAL,CAAY4C,QAAZ,IAAwB,KAAK5C,MAAL,CAAY2C,OAApC,GACK,GAAE,KAAK3C,MAAL,CAAY0B,IAAK,mBADxB,GAEIO,SAL6B;MAMnCY,OAAO,EAAE,KAAK7C,MAAL,CAAY2C,OAAZ,GACL;QACEjB,IAAI,EAAE,KAAK1B,MAAL,CAAY0B,IADpB;QAEEoB,IAAI,EAAE,MAFR;QAGE,GAAG,KAAK9C,MAAL,CAAY6C;MAHjB,CADK,GAMLZ,SAZ+B;MAanCP,IAAI,EAAE,KAAK1B,MAAL,CAAY0B,IAbiB;MAcnCN,MAAM,EAAEqB,kBAd2B;MAenCM,UAAU,EAAE,KAAK/C,MAAL,CAAY+C,UAfW;MAgBnCP,OAhBmC;MAiBnCQ,UAAU,EAAE,KAAKhD,MAAL,CAAYgD,UAjBW;MAkBnCC,OAAO,EAAE,KAAKjD,MAAL,CAAYiD;IAlBc,CAArC,EAmBGX,KAnBH,CAmBSC,QAnBT;EAoBD;;AA3J0D"}