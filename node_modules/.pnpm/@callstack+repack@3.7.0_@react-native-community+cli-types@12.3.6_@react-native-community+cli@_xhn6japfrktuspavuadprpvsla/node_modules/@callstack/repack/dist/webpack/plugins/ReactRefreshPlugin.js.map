{"version":3,"file":"ReactRefreshPlugin.js","names":["ReactRefreshPlugin","constructor","config","apply","compiler","webpack","DefinePlugin","__PUBLIC_PORT__","JSON","stringify","port","__PLATFORM__","platform","hmr","HotModuleReplacementPlugin","ReactRefreshWebpackPlugin","overlay","getAdjustedEntry","entry","key","import","entryImports","refreshEntryIndex","findIndex","value","test","refreshEntry","splice","hmrClientIndex","options","getEntry"],"sources":["../../../src/webpack/plugins/ReactRefreshPlugin.ts"],"sourcesContent":["import webpack from 'webpack';\nimport ReactRefreshWebpackPlugin from '@pmmmwh/react-refresh-webpack-plugin';\nimport type { DevServerOptions, WebpackPlugin } from '../../types';\n\ntype ExtractEntryStaticNormalized<E> = E extends () => Promise<infer U>\n  ? U\n  : E extends { [key: string]: any }\n  ? E\n  : never;\n\ntype EntryStaticNormalized =\n  ExtractEntryStaticNormalized<webpack.EntryNormalized>;\n\n/**\n * {@link ReactRefreshPlugin} configuration options.\n */\nexport interface ReactRefreshPluginConfig extends DevServerOptions {\n  platform: string;\n}\n\n/**\n * Class for setting up Hot Module Replacement and React Refresh support using `@pmmmwh/react-refresh-webpack-plugin`.\n *\n * @category Webpack Plugin\n */\nexport class ReactRefreshPlugin implements WebpackPlugin {\n  /**\n   * Constructs new `ReactRefreshPlugin`.\n   *\n   * @param config Plugin configuration options.\n   */\n  constructor(private config?: ReactRefreshPluginConfig) {}\n\n  /**\n   * Apply the plugin.\n   *\n   * @param compiler Webpack compiler instance.\n   */\n  apply(compiler: webpack.Compiler) {\n    if (!this.config) {\n      return;\n    }\n\n    new webpack.DefinePlugin({\n      __PUBLIC_PORT__: JSON.stringify(this.config.port),\n      __PLATFORM__: JSON.stringify(this.config.platform),\n    }).apply(compiler);\n\n    if (this.config?.hmr) {\n      new webpack.HotModuleReplacementPlugin().apply(compiler);\n      new ReactRefreshWebpackPlugin({\n        overlay: false,\n      }).apply(compiler);\n\n      // To avoid the problem from https://github.com/facebook/react/issues/20377\n      // we need to move React Refresh entry that `ReactRefreshWebpackPlugin` injects, to evaluate right\n      // before the `WebpackHMRClient` and after `InitializeCore` which sets up React DevTools.\n      // Thanks to that the initialization order is correct:\n      // 0. Polyfills\n      // 1. `InitilizeCore` -> React DevTools\n      // 2. React Refresh Entry\n      // 3. `WebpackHMRClient`\n      const getAdjustedEntry = (entry: EntryStaticNormalized) => {\n        for (const key in entry) {\n          const { import: entryImports = [] } = entry[key];\n          const refreshEntryIndex = entryImports.findIndex((value) =>\n            /ReactRefreshEntry\\.js/.test(value)\n          );\n          if (refreshEntryIndex >= 0) {\n            const refreshEntry = entryImports[refreshEntryIndex];\n            entryImports.splice(refreshEntryIndex, 1);\n\n            const hmrClientIndex = entryImports.findIndex((value) =>\n              /WebpackHMRClient\\.js/.test(value)\n            );\n            entryImports.splice(hmrClientIndex, 0, refreshEntry);\n          }\n          entry[key].import = entryImports;\n        }\n\n        return entry;\n      };\n\n      if (typeof compiler.options.entry !== 'function') {\n        compiler.options.entry = getAdjustedEntry(compiler.options.entry);\n      } else {\n        const getEntry = compiler.options.entry;\n        compiler.options.entry = async () => {\n          const entry = await getEntry();\n          return getAdjustedEntry(entry);\n        };\n      }\n    }\n  }\n}\n"],"mappings":";;;;;;;AAAA;;AACA;;;;AAmBA;AACA;AACA;AACA;AACA;AACO,MAAMA,kBAAN,CAAkD;EACvD;AACF;AACA;AACA;AACA;EACEC,WAAW,CAASC,MAAT,EAA4C;IAAA,KAAnCA,MAAmC,GAAnCA,MAAmC;EAAE;EAEzD;AACF;AACA;AACA;AACA;;;EACEC,KAAK,CAACC,QAAD,EAA6B;IAAA;;IAChC,IAAI,CAAC,KAAKF,MAAV,EAAkB;MAChB;IACD;;IAED,IAAIG,gBAAA,CAAQC,YAAZ,CAAyB;MACvBC,eAAe,EAAEC,IAAI,CAACC,SAAL,CAAe,KAAKP,MAAL,CAAYQ,IAA3B,CADM;MAEvBC,YAAY,EAAEH,IAAI,CAACC,SAAL,CAAe,KAAKP,MAAL,CAAYU,QAA3B;IAFS,CAAzB,EAGGT,KAHH,CAGSC,QAHT;;IAKA,oBAAI,KAAKF,MAAT,yCAAI,aAAaW,GAAjB,EAAsB;MACpB,IAAIR,gBAAA,CAAQS,0BAAZ,GAAyCX,KAAzC,CAA+CC,QAA/C;MACA,IAAIW,kCAAJ,CAA8B;QAC5BC,OAAO,EAAE;MADmB,CAA9B,EAEGb,KAFH,CAESC,QAFT,EAFoB,CAMpB;MACA;MACA;MACA;MACA;MACA;MACA;MACA;;MACA,MAAMa,gBAAgB,GAAIC,KAAD,IAAkC;QACzD,KAAK,MAAMC,GAAX,IAAkBD,KAAlB,EAAyB;UACvB,MAAM;YAAEE,MAAM,EAAEC,YAAY,GAAG;UAAzB,IAAgCH,KAAK,CAACC,GAAD,CAA3C;UACA,MAAMG,iBAAiB,GAAGD,YAAY,CAACE,SAAb,CAAwBC,KAAD,IAC/C,wBAAwBC,IAAxB,CAA6BD,KAA7B,CADwB,CAA1B;;UAGA,IAAIF,iBAAiB,IAAI,CAAzB,EAA4B;YAC1B,MAAMI,YAAY,GAAGL,YAAY,CAACC,iBAAD,CAAjC;YACAD,YAAY,CAACM,MAAb,CAAoBL,iBAApB,EAAuC,CAAvC;YAEA,MAAMM,cAAc,GAAGP,YAAY,CAACE,SAAb,CAAwBC,KAAD,IAC5C,uBAAuBC,IAAvB,CAA4BD,KAA5B,CADqB,CAAvB;YAGAH,YAAY,CAACM,MAAb,CAAoBC,cAApB,EAAoC,CAApC,EAAuCF,YAAvC;UACD;;UACDR,KAAK,CAACC,GAAD,CAAL,CAAWC,MAAX,GAAoBC,YAApB;QACD;;QAED,OAAOH,KAAP;MACD,CAnBD;;MAqBA,IAAI,OAAOd,QAAQ,CAACyB,OAAT,CAAiBX,KAAxB,KAAkC,UAAtC,EAAkD;QAChDd,QAAQ,CAACyB,OAAT,CAAiBX,KAAjB,GAAyBD,gBAAgB,CAACb,QAAQ,CAACyB,OAAT,CAAiBX,KAAlB,CAAzC;MACD,CAFD,MAEO;QACL,MAAMY,QAAQ,GAAG1B,QAAQ,CAACyB,OAAT,CAAiBX,KAAlC;;QACAd,QAAQ,CAACyB,OAAT,CAAiBX,KAAjB,GAAyB,YAAY;UACnC,MAAMA,KAAK,GAAG,MAAMY,QAAQ,EAA5B;UACA,OAAOb,gBAAgB,CAACC,KAAD,CAAvB;QACD,CAHD;MAID;IACF;EACF;;AApEsD"}