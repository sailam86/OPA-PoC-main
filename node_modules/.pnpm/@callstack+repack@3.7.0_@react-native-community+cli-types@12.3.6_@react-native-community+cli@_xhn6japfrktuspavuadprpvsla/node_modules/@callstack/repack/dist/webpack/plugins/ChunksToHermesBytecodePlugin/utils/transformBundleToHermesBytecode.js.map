{"version":3,"file":"transformBundleToHermesBytecode.js","names":["transformBundleToHermesBytecode","hermesCLIPath","useSourceMaps","bundlePath","hermesBundlePath","hermesSourceMapPath","execa","filter","Boolean","fs","unlink","rename","sourceMap","error","message","toString","Error"],"sources":["../../../../../src/webpack/plugins/ChunksToHermesBytecodePlugin/utils/transformBundleToHermesBytecode.ts"],"sourcesContent":["import fs from 'fs-extra';\nimport execa from 'execa';\n\ninterface TransformBundleToHermesBytecodeOptions {\n  /** Path to the Hermes compiler binary. */\n  hermesCLIPath: string;\n\n  /** Whether to generate source maps. */\n  useSourceMaps: boolean;\n\n  /** Path to the bundle to be transformed. */\n  bundlePath: string;\n}\n\n/**\n * Transforms a bundle to Hermes bytecode.\n *\n * Logic based on implementations for each platform.\n * - iOS: [react-native-xcode.sh](https://github.com/facebook/react-native/blob/f38fc9ba8681622f7cfdb586753e50c596946929/packages/react-native/scripts/react-native-xcode.sh#L166-L187)\n * - Android: [BundleHermesCTask.kt](https://github.com/facebook/react-native/blob/f38fc9ba8681622f7cfdb586753e50c596946929/packages/react-native-gradle-plugin/src/main/kotlin/com/facebook/react/tasks/BundleHermesCTask.kt#L93-L111) (with defaults in [ReactExtension.kt](https://github.com/facebook/react-native/blob/f38fc9ba8681622f7cfdb586753e50c596946929/packages/react-native-gradle-plugin/src/main/kotlin/com/facebook/react/ReactExtension.kt#L116-L117))\n */\nexport const transformBundleToHermesBytecode = async ({\n  hermesCLIPath,\n  useSourceMaps,\n  bundlePath,\n}: TransformBundleToHermesBytecodeOptions) => {\n  const hermesBundlePath = bundlePath + '.hbc';\n  const hermesSourceMapPath = bundlePath + '.hbc.map';\n\n  try {\n    // Transform bundle to bytecode\n    await execa(\n      hermesCLIPath,\n      [\n        '-w', // Silence warnings else buffer overflows\n        '-O', // Enable optimizations\n        '-emit-binary',\n        '-out',\n        hermesBundlePath,\n        useSourceMaps ? '-output-source-map' : '',\n        bundlePath,\n      ].filter(Boolean)\n    );\n\n    await fs.unlink(bundlePath);\n    await fs.rename(hermesBundlePath, bundlePath);\n\n    return { sourceMap: hermesSourceMapPath };\n  } catch (error) {\n    const message = (error as Error).toString();\n    throw new Error(\n      `ChunksToHermesBytecodePlugin: Failed to transform bundle ${bundlePath}. Reason:\\n${message})`\n    );\n  }\n};\n"],"mappings":";;;;;;;AAAA;;AACA;;;;AAaA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,MAAMA,+BAA+B,GAAG,OAAO;EACpDC,aADoD;EAEpDC,aAFoD;EAGpDC;AAHoD,CAAP,KAID;EAC5C,MAAMC,gBAAgB,GAAGD,UAAU,GAAG,MAAtC;EACA,MAAME,mBAAmB,GAAGF,UAAU,GAAG,UAAzC;;EAEA,IAAI;IACF;IACA,MAAM,IAAAG,cAAA,EACJL,aADI,EAEJ,CACE,IADF,EACQ;IACN,IAFF,EAEQ;IACN,cAHF,EAIE,MAJF,EAKEG,gBALF,EAMEF,aAAa,GAAG,oBAAH,GAA0B,EANzC,EAOEC,UAPF,EAQEI,MARF,CAQSC,OART,CAFI,CAAN;IAaA,MAAMC,gBAAA,CAAGC,MAAH,CAAUP,UAAV,CAAN;IACA,MAAMM,gBAAA,CAAGE,MAAH,CAAUP,gBAAV,EAA4BD,UAA5B,CAAN;IAEA,OAAO;MAAES,SAAS,EAAEP;IAAb,CAAP;EACD,CAnBD,CAmBE,OAAOQ,KAAP,EAAc;IACd,MAAMC,OAAO,GAAID,KAAD,CAAiBE,QAAjB,EAAhB;IACA,MAAM,IAAIC,KAAJ,CACH,4DAA2Db,UAAW,cAAaW,OAAQ,GADxF,CAAN;EAGD;AACF,CAjCM"}