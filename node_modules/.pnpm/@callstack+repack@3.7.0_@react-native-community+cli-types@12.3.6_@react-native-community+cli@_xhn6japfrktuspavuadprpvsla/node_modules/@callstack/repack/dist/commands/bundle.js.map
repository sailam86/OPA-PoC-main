{"version":3,"file":"bundle.js","names":["bundle","_","config","args","webpackConfigPath","getWebpackConfigPath","root","webpackConfig","cliOptions","reactNativePath","command","arguments","verbose","process","argv","includes","env","VERBOSE_ENV_KEY","webpackEnvOptions","getWebpackEnvOptions","loadWebpackConfig","compiler","webpack","Promise","resolve","reject","run","error","stats","console","exit","hasErrors","json","undefined","log","statOptions","preset","options","statsJson","toJson","outputStream","fs","createWriteStream","stringifyStream","on","pipe","then","close"],"sources":["../../src/commands/bundle.ts"],"sourcesContent":["import { Config } from '@react-native-community/cli-types';\nimport fs from 'fs-extra';\nimport { stringifyStream } from '@discoveryjs/json-ext';\nimport webpack from 'webpack';\nimport { VERBOSE_ENV_KEY } from '../env';\nimport { BundleArguments, CliOptions } from '../types';\nimport { loadWebpackConfig } from '../webpack/loadWebpackConfig';\nimport { getWebpackEnvOptions } from '../webpack/utils';\nimport { getWebpackConfigPath } from './utils/getWebpackConfigPath';\n\n/**\n * Bundle command for React Native CLI.\n * It runs Webpack, builds bundle and saves it alongside any other assets and Source Map\n * to filesystem.\n *\n * @param _ Original, non-parsed arguments that were provided when running this command.\n * @param config React Native CLI configuration object.\n * @param args Parsed command line arguments.\n *\n * @internal\n * @category CLI command\n */\nexport async function bundle(\n  _: string[],\n  config: Config,\n  args: BundleArguments\n) {\n  const webpackConfigPath = getWebpackConfigPath(\n    config.root,\n    args.webpackConfig\n  );\n  const cliOptions = {\n    config: {\n      root: config.root,\n      reactNativePath: config.reactNativePath,\n      webpackConfigPath,\n    },\n    command: 'bundle',\n    arguments: {\n      bundle: args,\n    },\n  } as CliOptions;\n\n  if (args.verbose ?? process.argv.includes('--verbose')) {\n    process.env[VERBOSE_ENV_KEY] = '1';\n  }\n\n  const webpackEnvOptions = getWebpackEnvOptions(cliOptions);\n  const webpackConfig = await loadWebpackConfig(\n    webpackConfigPath,\n    webpackEnvOptions\n  );\n  const compiler = webpack(webpackConfig);\n\n  return new Promise<void>((resolve, reject) => {\n    compiler.run((error, stats) => {\n      if (error) {\n        reject();\n        console.error(error);\n        process.exit(2);\n      } else {\n        if (stats?.hasErrors()) {\n          reject();\n          process.exit(2);\n        }\n\n        if (args.json && stats !== undefined) {\n          console.log(`Writing compiler stats`);\n\n          let statOptions: Parameters<typeof stats.toJson>[0];\n          if (args.stats !== undefined) {\n            statOptions = { preset: args.stats };\n          } else if (typeof compiler.options.stats === 'boolean') {\n            statOptions = compiler.options.stats\n              ? { preset: 'normal' }\n              : { preset: 'none' };\n          } else {\n            statOptions = compiler.options.stats;\n          }\n\n          const statsJson = stats.toJson(statOptions);\n          // Stats can be fairly big at which point their JSON no longer fits into a single string.\n          // Approach was copied from `webpack-cli`: https://github.com/webpack/webpack-cli/blob/c03fb03d0aa73d21f16bd9263fd3109efaf0cd28/packages/webpack-cli/src/webpack-cli.ts#L2471-L2482\n          const outputStream = fs.createWriteStream(args.json);\n\n          stringifyStream(statsJson)\n            .on('error', (error) => {\n              reject();\n              console.error(error);\n              process.exit(2);\n            })\n            .pipe(outputStream)\n            .on('error', (error) => {\n              reject();\n              console.error(error);\n              process.exit(2);\n            })\n            .on('close', () => {\n              console.log(`Wrote compiler stats to ${args.json}`);\n              resolve();\n            });\n        } else {\n          resolve();\n        }\n      }\n    });\n    // eslint-disable-next-line promise/prefer-await-to-then\n  }).then(() => {\n    return new Promise<void>((resolve, reject) => {\n      // make cache work: https://webpack.js.org/api/node/#run\n      compiler.close((error) => {\n        if (error) {\n          reject();\n        } else {\n          resolve();\n        }\n      });\n    });\n  });\n}\n"],"mappings":"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"}