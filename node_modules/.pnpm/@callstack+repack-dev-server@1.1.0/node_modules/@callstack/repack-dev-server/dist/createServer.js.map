{"version":3,"file":"createServer.js","names":["Writable","Fastify","fastifySensible","fastifyStatic","debuggerAppPath","multipartPlugin","compilerPlugin","devtoolsPlugin","apiPlugin","wssPlugin","faviconPlugin","Internal","symbolicatePlugin","createServer","config","delegate","instance","logger","level","stream","write","chunk","_encoding","callback","log","JSON","parse","toString","onMessage","wss","apiServer","send","options","https","undefined","notifyBuildStart","platform","event","EventTypes","BuildStart","notifyBuildEnd","BuildEnd","broadcastToHmrClients","clientIds","hmrServer","broadcastToMessageClients","method","params","messageServer","broadcast","register","prefix","root","prefixAvoidTrailingSlash","addHook","request","reply","payload","header","rootDir","pathname","url","split","endsWith","get","messages","getHello","getStatus","start","listen","port","host","stop","close"],"sources":["../src/createServer.ts"],"sourcesContent":["import { Writable } from 'stream';\nimport Fastify from 'fastify';\nimport fastifySensible from '@fastify/sensible';\nimport fastifyStatic from '@fastify/static';\nimport debuggerAppPath from '@callstack/repack-debugger-app';\nimport multipartPlugin from './plugins/multipart';\nimport compilerPlugin from './plugins/compiler';\nimport devtoolsPlugin from './plugins/devtools';\nimport apiPlugin from './plugins/api';\nimport wssPlugin from './plugins/wss';\nimport faviconPlugin from './plugins/favicon';\nimport { Internal, Server } from './types';\nimport symbolicatePlugin from './plugins/symbolicate';\n\n/**\n * Create instance of development server, powered by Fastify.\n *\n * @param config Server configuration.\n * @returns `start` and `stop` functions as well as an underlying Fastify `instance`.\n */\nexport async function createServer(config: Server.Config) {\n  let delegate: Server.Delegate;\n\n  /** Fastify instance powering the development server. */\n  const instance = Fastify({\n    logger: {\n      level: 'trace',\n      stream: new Writable({\n        write: (chunk, _encoding, callback) => {\n          const log = JSON.parse(chunk.toString());\n          delegate?.logger.onMessage(log);\n          instance.wss?.apiServer.send(log);\n          callback();\n        },\n      }),\n    },\n    ...(config.options.https ? { https: config.options.https } : undefined),\n  });\n\n  delegate = config.delegate({\n    log: instance.log,\n    notifyBuildStart: (platform) => {\n      instance.wss.apiServer.send({\n        event: Internal.EventTypes.BuildStart,\n        platform,\n      });\n    },\n    notifyBuildEnd: (platform) => {\n      instance.wss.apiServer.send({\n        event: Internal.EventTypes.BuildEnd,\n        platform,\n      });\n    },\n    broadcastToHmrClients: (event, platform, clientIds) => {\n      instance.wss.hmrServer.send(event, platform, clientIds);\n    },\n    broadcastToMessageClients: ({ method, params }) => {\n      instance.wss.messageServer.broadcast(method, params);\n    },\n  });\n\n  // Register plugins\n  await instance.register(fastifySensible);\n  await instance.register(wssPlugin, {\n    options: config.options,\n    delegate,\n  });\n  await instance.register(multipartPlugin);\n  await instance.register(apiPlugin, {\n    delegate,\n    prefix: '/api',\n  });\n  await instance.register(compilerPlugin, {\n    delegate,\n  });\n  await instance.register(symbolicatePlugin, {\n    delegate,\n  });\n  await instance.register(devtoolsPlugin, {\n    options: config.options,\n  });\n\n  await instance.register(fastifyStatic, {\n    root: debuggerAppPath,\n    prefix: '/debugger-ui',\n    prefixAvoidTrailingSlash: true,\n  });\n  // below is to prevent showing `GET 400 /favicon.ico`\n  // errors in console when requesting the bundle via browser\n  await instance.register(faviconPlugin);\n\n  instance.addHook('onSend', async (request, reply, payload) => {\n    reply.header('X-Content-Type-Options', 'nosniff');\n    reply.header('X-React-Native-Project-Root', config.options.rootDir);\n\n    const [pathname] = request.url.split('?');\n    if (pathname.endsWith('.map')) {\n      reply.header('Access-Control-Allow-Origin', 'devtools://devtools');\n    }\n\n    return payload;\n  });\n\n  // Register routes\n  instance.get('/', async () => delegate.messages.getHello());\n  instance.get('/status', async () => delegate.messages.getStatus());\n\n  /** Start the development server. */\n  async function start() {\n    await instance.listen(config.options.port, config.options.host);\n  }\n\n  /** Stop the development server. */\n  async function stop() {\n    await instance.close();\n  }\n\n  return {\n    start,\n    stop,\n    instance,\n  };\n}\n"],"mappings":"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"}