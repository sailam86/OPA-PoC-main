{"version":3,"file":"WebSocketDevClientServer.js","names":["WebSocketServer","WebSocketDevClientServer","clients","Map","nextClientId","constructor","fastify","processMessage","message","type","body","JSON","parse","level","log","error","issuer","msg","data","warn","info","onConnection","socket","clientId","set","onClose","delete","addEventListener","event","toString"],"sources":["../../../../src/plugins/wss/servers/WebSocketDevClientServer.ts"],"sourcesContent":["import WebSocket from 'ws';\nimport type { FastifyInstance } from 'fastify';\nimport { WebSocketServer } from '../WebSocketServer';\n\n/**\n * Class for creating a WebSocket server for communication with React Native clients.\n * All client logs - logs from React Native application - are processed here.\n *\n * @category Development server\n */\nexport class WebSocketDevClientServer extends WebSocketServer {\n  private clients = new Map<string, WebSocket>();\n  private nextClientId = 0;\n\n  /**\n   * Create new instance of WebSocketDevClientServer and attach it to the given Fastify instance.\n   * Any logging information, will be passed through standard `fastify.log` API.\n   *\n   * @param fastify Fastify instance to attach the WebSocket server to.\n   */\n  constructor(fastify: FastifyInstance) {\n    super(fastify, '/__client');\n  }\n\n  /**\n   * Process client message.\n   *\n   * @param message Stringified client message.\n   */\n  processMessage(message: string) {\n    const { type, ...body } = JSON.parse(message);\n    switch (type) {\n      case 'client-log':\n        if (body.level === 'error') {\n          this.fastify.log.error({ issuer: 'Console', msg: body.data });\n        } else if (body.level === 'warn') {\n          this.fastify.log.warn({ issuer: 'Console', msg: body.data });\n        } else {\n          this.fastify.log.info({ issuer: 'Console', msg: body.data });\n        }\n        break;\n      default:\n        this.fastify.log.warn({ msg: 'Unknown client message', message });\n    }\n  }\n\n  /**\n   * Process new WebSocket connection from client application.\n   *\n   * @param socket Incoming client's WebSocket connection.\n   */\n  onConnection(socket: WebSocket) {\n    const clientId = `client#${this.nextClientId++}`;\n    this.clients.set(clientId, socket);\n\n    this.fastify.log.info({ msg: 'React Native client connected', clientId });\n    this.clients.set(clientId, socket);\n\n    const onClose = () => {\n      this.fastify.log.info({\n        msg: 'React Native client disconnected',\n        clientId,\n      });\n      this.clients.delete(clientId);\n    };\n\n    socket.addEventListener('error', onClose);\n    socket.addEventListener('close', onClose);\n    socket.addEventListener('message', (event) => {\n      this.processMessage(event.data.toString());\n    });\n  }\n}\n"],"mappings":"SAESA,e;AAET;AACA;AACA;AACA;AACA;AACA;;AACA,OAAO,MAAMC,wBAAN,SAAuCD,eAAvC,CAAuD;EACpDE,OAAO,GAAG,IAAIC,GAAJ,EAAH;EACPC,YAAY,GAAG,CAAH;EAEpB;AACF;AACA;AACA;AACA;AACA;;EACEC,WAAW,CAACC,OAAD,EAA2B;IACpC,MAAMA,OAAN,EAAe,WAAf;EACD;EAED;AACF;AACA;AACA;AACA;;;EACEC,cAAc,CAACC,OAAD,EAAkB;IAC9B,MAAM;MAAEC,IAAF;MAAQ,GAAGC;IAAX,IAAoBC,IAAI,CAACC,KAAL,CAAWJ,OAAX,CAA1B;;IACA,QAAQC,IAAR;MACE,KAAK,YAAL;QACE,IAAIC,IAAI,CAACG,KAAL,KAAe,OAAnB,EAA4B;UAC1B,KAAKP,OAAL,CAAaQ,GAAb,CAAiBC,KAAjB,CAAuB;YAAEC,MAAM,EAAE,SAAV;YAAqBC,GAAG,EAAEP,IAAI,CAACQ;UAA/B,CAAvB;QACD,CAFD,MAEO,IAAIR,IAAI,CAACG,KAAL,KAAe,MAAnB,EAA2B;UAChC,KAAKP,OAAL,CAAaQ,GAAb,CAAiBK,IAAjB,CAAsB;YAAEH,MAAM,EAAE,SAAV;YAAqBC,GAAG,EAAEP,IAAI,CAACQ;UAA/B,CAAtB;QACD,CAFM,MAEA;UACL,KAAKZ,OAAL,CAAaQ,GAAb,CAAiBM,IAAjB,CAAsB;YAAEJ,MAAM,EAAE,SAAV;YAAqBC,GAAG,EAAEP,IAAI,CAACQ;UAA/B,CAAtB;QACD;;QACD;;MACF;QACE,KAAKZ,OAAL,CAAaQ,GAAb,CAAiBK,IAAjB,CAAsB;UAAEF,GAAG,EAAE,wBAAP;UAAiCT;QAAjC,CAAtB;IAXJ;EAaD;EAED;AACF;AACA;AACA;AACA;;;EACEa,YAAY,CAACC,MAAD,EAAoB;IAC9B,MAAMC,QAAQ,GAAI,UAAS,KAAKnB,YAAL,EAAoB,EAA/C;IACA,KAAKF,OAAL,CAAasB,GAAb,CAAiBD,QAAjB,EAA2BD,MAA3B;IAEA,KAAKhB,OAAL,CAAaQ,GAAb,CAAiBM,IAAjB,CAAsB;MAAEH,GAAG,EAAE,+BAAP;MAAwCM;IAAxC,CAAtB;IACA,KAAKrB,OAAL,CAAasB,GAAb,CAAiBD,QAAjB,EAA2BD,MAA3B;;IAEA,MAAMG,OAAO,GAAG,MAAM;MACpB,KAAKnB,OAAL,CAAaQ,GAAb,CAAiBM,IAAjB,CAAsB;QACpBH,GAAG,EAAE,kCADe;QAEpBM;MAFoB,CAAtB;MAIA,KAAKrB,OAAL,CAAawB,MAAb,CAAoBH,QAApB;IACD,CAND;;IAQAD,MAAM,CAACK,gBAAP,CAAwB,OAAxB,EAAiCF,OAAjC;IACAH,MAAM,CAACK,gBAAP,CAAwB,OAAxB,EAAiCF,OAAjC;IACAH,MAAM,CAACK,gBAAP,CAAwB,SAAxB,EAAoCC,KAAD,IAAW;MAC5C,KAAKrB,cAAL,CAAoBqB,KAAK,CAACV,IAAN,CAAWW,QAAX,EAApB;IACD,CAFD;EAGD;;AA7D2D"}