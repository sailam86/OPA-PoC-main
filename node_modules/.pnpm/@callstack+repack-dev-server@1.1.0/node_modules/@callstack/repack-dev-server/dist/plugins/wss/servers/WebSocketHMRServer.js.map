{"version":3,"file":"WebSocketHMRServer.js","names":["URL","WebSocketServer","WebSocketHMRServer","clients","Map","nextClientId","constructor","fastify","delegate","getUriPath","send","event","platform","clientIds","data","JSON","stringify","key","socket","clientId","includes","error","log","msg","onConnection","request","searchParams","url","get","info","close","set","onClose","delete","addEventListener","onClientConnected"],"sources":["../../../../src/plugins/wss/servers/WebSocketHMRServer.ts"],"sourcesContent":["import { URL } from 'url';\nimport { IncomingMessage } from 'http';\nimport { FastifyInstance } from 'fastify';\nimport WebSocket from 'ws';\nimport { HmrDelegate } from '../types';\nimport { WebSocketServer } from '../WebSocketServer';\n\n/**\n * Class for creating a WebSocket server for Hot Module Replacement.\n *\n * @category Development server\n */\nexport class WebSocketHMRServer extends WebSocketServer {\n  private clients = new Map<\n    { clientId: string; platform: string },\n    WebSocket\n  >();\n  private nextClientId = 0;\n\n  /**\n   * Create new instance of WebSocketHMRServer and attach it to the given Fastify instance.\n   * Any logging information, will be passed through standard `fastify.log` API.\n   *\n   * @param fastify Fastify instance to attach the WebSocket server to.\n   * @param delegate HMR delegate instance.\n   */\n  constructor(fastify: FastifyInstance, private delegate: HmrDelegate) {\n    super(fastify, delegate.getUriPath());\n  }\n\n  /**\n   * Send action to all connected HMR clients.\n   *\n   * @param event Event to send to the clients.\n   * @param platform Platform of clients to send the event to.\n   * @param clientIds Ids of clients who should receive the event.\n   */\n  send(event: any, platform: string, clientIds?: string[]) {\n    const data = typeof event === 'string' ? event : JSON.stringify(event);\n\n    for (const [key, socket] of this.clients) {\n      if (\n        key.platform !== platform ||\n        !(clientIds ?? [key.clientId]).includes(key.clientId)\n      ) {\n        return;\n      }\n\n      try {\n        socket.send(data);\n      } catch (error) {\n        this.fastify.log.error({\n          msg: 'Cannot send action to client',\n          event,\n          error,\n          ...key,\n        });\n      }\n    }\n  }\n\n  /**\n   * Process new WebSocket connection from HMR client.\n   *\n   * @param socket Incoming HMR client's WebSocket connection.\n   */\n  onConnection(socket: WebSocket, request: IncomingMessage) {\n    const { searchParams } = new URL(request.url || '', 'http://localhost');\n    const platform = searchParams.get('platform');\n\n    if (!platform) {\n      this.fastify.log.info({\n        msg: 'HMR connection disconnected - missing platform',\n      });\n      socket.close();\n      return;\n    }\n\n    const clientId = `client#${this.nextClientId++}`;\n    this.clients.set({ clientId, platform }, socket);\n\n    this.fastify.log.info({ msg: 'HMR client connected', clientId, platform });\n\n    const onClose = () => {\n      this.fastify.log.info({\n        msg: 'HMR client disconnected',\n        clientId,\n        platform,\n      });\n      this.clients.delete({ clientId, platform });\n    };\n\n    socket.addEventListener('error', onClose);\n    socket.addEventListener('close', onClose);\n\n    this.delegate.onClientConnected(platform, clientId);\n  }\n}\n"],"mappings":"AAAA,SAASA,GAAT,QAAoB,KAApB;SAKSC,e;AAET;AACA;AACA;AACA;AACA;;AACA,OAAO,MAAMC,kBAAN,SAAiCD,eAAjC,CAAiD;EAC9CE,OAAO,GAAG,IAAIC,GAAJ,EAAH;EAIPC,YAAY,GAAG,CAAH;EAEpB;AACF;AACA;AACA;AACA;AACA;AACA;;EACEC,WAAW,CAACC,OAAD,EAAmCC,QAAnC,EAA0D;IACnE,MAAMD,OAAN,EAAeC,QAAQ,CAACC,UAAT,EAAf;IADmE,KAAvBD,QAAuB,GAAvBA,QAAuB;EAEpE;EAED;AACF;AACA;AACA;AACA;AACA;AACA;;;EACEE,IAAI,CAACC,KAAD,EAAaC,QAAb,EAA+BC,SAA/B,EAAqD;IACvD,MAAMC,IAAI,GAAG,OAAOH,KAAP,KAAiB,QAAjB,GAA4BA,KAA5B,GAAoCI,IAAI,CAACC,SAAL,CAAeL,KAAf,CAAjD;;IAEA,KAAK,MAAM,CAACM,GAAD,EAAMC,MAAN,CAAX,IAA4B,KAAKf,OAAjC,EAA0C;MACxC,IACEc,GAAG,CAACL,QAAJ,KAAiBA,QAAjB,IACA,CAAC,CAACC,SAAS,IAAI,CAACI,GAAG,CAACE,QAAL,CAAd,EAA8BC,QAA9B,CAAuCH,GAAG,CAACE,QAA3C,CAFH,EAGE;QACA;MACD;;MAED,IAAI;QACFD,MAAM,CAACR,IAAP,CAAYI,IAAZ;MACD,CAFD,CAEE,OAAOO,KAAP,EAAc;QACd,KAAKd,OAAL,CAAae,GAAb,CAAiBD,KAAjB,CAAuB;UACrBE,GAAG,EAAE,8BADgB;UAErBZ,KAFqB;UAGrBU,KAHqB;UAIrB,GAAGJ;QAJkB,CAAvB;MAMD;IACF;EACF;EAED;AACF;AACA;AACA;AACA;;;EACEO,YAAY,CAACN,MAAD,EAAoBO,OAApB,EAA8C;IACxD,MAAM;MAAEC;IAAF,IAAmB,IAAI1B,GAAJ,CAAQyB,OAAO,CAACE,GAAR,IAAe,EAAvB,EAA2B,kBAA3B,CAAzB;IACA,MAAMf,QAAQ,GAAGc,YAAY,CAACE,GAAb,CAAiB,UAAjB,CAAjB;;IAEA,IAAI,CAAChB,QAAL,EAAe;MACb,KAAKL,OAAL,CAAae,GAAb,CAAiBO,IAAjB,CAAsB;QACpBN,GAAG,EAAE;MADe,CAAtB;MAGAL,MAAM,CAACY,KAAP;MACA;IACD;;IAED,MAAMX,QAAQ,GAAI,UAAS,KAAKd,YAAL,EAAoB,EAA/C;IACA,KAAKF,OAAL,CAAa4B,GAAb,CAAiB;MAAEZ,QAAF;MAAYP;IAAZ,CAAjB,EAAyCM,MAAzC;IAEA,KAAKX,OAAL,CAAae,GAAb,CAAiBO,IAAjB,CAAsB;MAAEN,GAAG,EAAE,sBAAP;MAA+BJ,QAA/B;MAAyCP;IAAzC,CAAtB;;IAEA,MAAMoB,OAAO,GAAG,MAAM;MACpB,KAAKzB,OAAL,CAAae,GAAb,CAAiBO,IAAjB,CAAsB;QACpBN,GAAG,EAAE,yBADe;QAEpBJ,QAFoB;QAGpBP;MAHoB,CAAtB;MAKA,KAAKT,OAAL,CAAa8B,MAAb,CAAoB;QAAEd,QAAF;QAAYP;MAAZ,CAApB;IACD,CAPD;;IASAM,MAAM,CAACgB,gBAAP,CAAwB,OAAxB,EAAiCF,OAAjC;IACAd,MAAM,CAACgB,gBAAP,CAAwB,OAAxB,EAAiCF,OAAjC;IAEA,KAAKxB,QAAL,CAAc2B,iBAAd,CAAgCvB,QAAhC,EAA0CO,QAA1C;EACD;;AApFqD"}