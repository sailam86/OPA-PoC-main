{"version":3,"file":"devtoolsPlugin.js","names":["path","open","openEditor","fastifyPlugin","devtoolsPlugin","instance","options","route","method","url","handler","_request","reply","wss","messageServer","broadcast","send","request","customDebugger","process","env","REACT_DEBUGGER","debuggerServer","isDebuggerConnected","https","host","port","log","info","msg","error","file","lineNumber","column","body","JSON","parse","join","rootDir","replace","message","code","get","logLevel","name","dependencies"],"sources":["../../../src/plugins/devtools/devtoolsPlugin.ts"],"sourcesContent":["import path from 'path';\nimport open from 'open';\nimport openEditor from 'open-editor';\nimport type { FastifyInstance } from 'fastify';\nimport fastifyPlugin from 'fastify-plugin';\nimport type { Server } from '../../types';\n\nasync function devtoolsPlugin(\n  instance: FastifyInstance,\n  { options }: { options: Server.Options }\n) {\n  instance.route({\n    method: ['GET', 'POST', 'PUT'],\n    url: '/reload',\n    handler: (_request, reply) => {\n      instance.wss.messageServer.broadcast('reload');\n      reply.send('OK');\n    },\n  });\n\n  instance.route({\n    method: ['GET', 'POST', 'PUT'],\n    url: '/launch-js-devtools',\n    handler: async (request, reply) => {\n      const customDebugger = process.env.REACT_DEBUGGER;\n      if (customDebugger) {\n        // NOOP for now\n      } else if (!instance.wss.debuggerServer.isDebuggerConnected()) {\n        const url = `${options.https ? 'https' : 'http'}://${\n          options.host || 'localhost'\n        }:${options.port}/debugger-ui`;\n        try {\n          request.log.info({ msg: 'Opening debugger UI', url });\n          await open(url);\n        } catch (error) {\n          if (error) {\n            request.log.error({\n              msg: 'Cannot open debugger UI',\n              url,\n              error,\n            });\n          }\n        }\n      }\n      reply.send('OK');\n    },\n  });\n\n  instance.route({\n    method: ['GET', 'POST', 'PUT'],\n    url: '/open-stack-frame',\n    handler: async (request, reply) => {\n      try {\n        const { file, lineNumber, column } = (\n          typeof request.body === 'string'\n            ? JSON.parse(request.body)\n            : request.body\n        ) as {\n          file: string;\n          lineNumber: number;\n          column?: number;\n        };\n        const url = `${path.join(\n          options.rootDir,\n          // TODO: make it generic\n          file.replace('webpack://', '')\n        )}:${lineNumber}:${column ?? 1}`;\n\n        request.log.info({ msg: 'Opening stack frame in editor', url });\n        openEditor([url]);\n        reply.send('OK');\n      } catch (error) {\n        request.log.error({\n          msg: 'Failed to open stack frame in editor',\n          error: (error as Error).message,\n        });\n        reply.code(400).send();\n      }\n    },\n  });\n\n  instance.route({\n    method: ['GET', 'POST', 'PUT'],\n    url: '/open-url',\n    handler: async (request, reply) => {\n      try {\n        const { url } = JSON.parse(request.body as string) as { url: string };\n        request.log.info({ msg: 'Opening URL', url });\n        await open(url);\n        reply.send('OK');\n      } catch (error) {\n        request.log.error({ msg: 'Failed to open URL', error });\n        reply.code(400).send();\n      }\n    },\n  });\n\n  // Silence this route\n  instance.get(\n    '/inspector/device',\n    { logLevel: 'silent' as any },\n    (_request, reply) => {\n      reply.code(404).send();\n    }\n  );\n}\n\nexport default fastifyPlugin(devtoolsPlugin, {\n  name: 'devtools-plugin',\n  dependencies: ['wss-plugin'],\n});\n"],"mappings":"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"}