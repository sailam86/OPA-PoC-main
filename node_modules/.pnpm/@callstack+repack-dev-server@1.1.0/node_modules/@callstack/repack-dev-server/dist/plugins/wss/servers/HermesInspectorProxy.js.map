{"version":3,"file":"HermesInspectorProxy.js","names":["URL","WebSocketServer","Device","WS_DEVICE_URL","WS_DEBUGGER_URL","HermesInspectorProxy","devices","Map","deviceCounter","constructor","fastify","config","serverHost","host","port","setup","onSend","_request","reply","_payload","done","headers","Connection","get","Browser","pageListHandler","pages","deviceId","device","devicePages","getPagesList","page","push","buildPageDescription","logLevel","debuggerUrl","id","webSocketDebuggerUrl","devtoolsFrontendUrl","encodeURIComponent","description","app","title","faviconUrl","type","vm","onConnection","socket","request","url","searchParams","startsWith","deviceName","appName","set","rootDir","log","info","msg","onClose","delete","addEventListener","undefined","pageId","Error","parseInt","handleDebuggerConnection","error","message","close","toString"],"sources":["../../../../src/plugins/wss/servers/HermesInspectorProxy.ts"],"sourcesContent":["import type { IncomingMessage } from 'http';\nimport { URL } from 'url';\nimport WebSocket from 'ws';\nimport type {\n  FastifyInstance,\n  FastifyReply,\n  FastifyRequest,\n  LogLevel,\n} from 'fastify';\nimport { WebSocketServer } from '../WebSocketServer';\nimport { Server } from '../../../types';\n// @ts-ignore\nimport Device from '../../../../vendor/metro-inspector-proxy/src/Device.js';\n\nconst WS_DEVICE_URL = '/inspector/device';\nconst WS_DEBUGGER_URL = '/inspector/debug';\n\ninterface PageDescription {\n  id: string;\n  description: string;\n  title: string;\n  faviconUrl: string;\n  devtoolsFrontendUrl: string;\n  type: string;\n  webSocketDebuggerUrl: string;\n  vm?: string;\n}\n\ninterface Page {\n  id: string;\n  title: string;\n  app: string;\n  vm?: string;\n}\n\nexport interface InspectorProxyConfig\n  extends Pick<Server.Options, 'port' | 'host' | 'rootDir'> {}\n\nexport class HermesInspectorProxy extends WebSocketServer {\n  private devices = new Map<number, any>();\n  private deviceCounter = 0;\n  public readonly serverHost: string;\n\n  constructor(fastify: FastifyInstance, private config: InspectorProxyConfig) {\n    super(fastify, [WS_DEVICE_URL, WS_DEBUGGER_URL]);\n    this.serverHost = `${this.config.host || 'localhost'}:${this.config.port}`;\n    this.setup();\n  }\n\n  private setup() {\n    const onSend = (\n      _request: FastifyRequest,\n      reply: FastifyReply,\n      _payload: unknown,\n      done: () => void\n    ) => {\n      reply.headers({\n        'Content-Type': 'application/json; charset=UTF-8',\n        'Cache-Control': 'no-cache',\n        Connection: 'close',\n      });\n      done();\n    };\n\n    this.fastify.get('/json/version', { onSend }, async () => {\n      return {\n        Browser: 'Mobile JavaScript',\n        'Protocol-Version': '1.1',\n      };\n    });\n\n    const pageListHandler = async () => {\n      const pages: PageDescription[] = [];\n      for (const [deviceId, device] of this.devices) {\n        const devicePages = device.getPagesList();\n        for (const page of devicePages) {\n          pages.push(this.buildPageDescription(deviceId, page));\n        }\n      }\n\n      return pages;\n    };\n\n    this.fastify.get('/json/list', { onSend }, pageListHandler);\n    this.fastify.get(\n      '/json',\n      { onSend, logLevel: 'silent' as LogLevel },\n      pageListHandler\n    );\n  }\n\n  private buildPageDescription(deviceId: number, page: Page) {\n    const debuggerUrl = `${this.serverHost}${WS_DEBUGGER_URL}?device=${deviceId}&page=${page.id}`;\n    const webSocketDebuggerUrl = 'ws://' + debuggerUrl;\n    const devtoolsFrontendUrl =\n      'chrome-devtools://devtools/bundled/inspector.html?experiments=true&v8only=true&ws=' +\n      encodeURIComponent(debuggerUrl);\n    return {\n      id: `${deviceId}-${page.id}`,\n      description: page.app,\n      title: page.title,\n      faviconUrl: 'https://reactjs.org/favicon.ico',\n      devtoolsFrontendUrl,\n      type: 'node',\n      webSocketDebuggerUrl,\n      vm: page.vm,\n    };\n  }\n\n  /**\n   * Process new WebSocket connection from device.\n   *\n   * @param socket Incoming device's WebSocket connection.\n   * @param request Upgrade request for the connection.\n   */\n  onConnection(socket: WebSocket, request: IncomingMessage) {\n    try {\n      const { url = '' } = request;\n      const { searchParams } = new URL(url, 'http://localhost');\n\n      if (url.startsWith('/inspector/device')) {\n        const deviceName = searchParams.get('name') ?? 'Unknown';\n        const appName = searchParams.get('app') ?? 'Unknown';\n        const deviceId = this.deviceCounter++;\n\n        this.devices.set(\n          deviceId,\n          new Device(deviceId, deviceName, appName, socket, this.config.rootDir)\n        );\n\n        this.fastify.log.info({ msg: 'Hermes device connected', deviceId });\n\n        const onClose = () => {\n          this.fastify.log.info({\n            msg: 'Hermes device disconnected',\n            deviceId,\n          });\n          this.devices.delete(deviceId);\n        };\n\n        socket.addEventListener('error', onClose);\n        socket.addEventListener('close', onClose);\n      } else {\n        const deviceId = searchParams.get('device') ?? undefined;\n        const pageId = searchParams.get('page') ?? undefined;\n\n        if (deviceId === undefined || pageId === undefined) {\n          throw new Error('Incorrect URL - must provide device and page IDs');\n        }\n\n        const device = this.devices.get(parseInt(deviceId, 10));\n        if (!device) {\n          throw new Error('Unknown device with ID ' + deviceId);\n        }\n\n        device.handleDebuggerConnection(socket, pageId);\n      }\n    } catch (error) {\n      this.fastify.log.error({\n        msg: 'Failed to establish connection with Hermes device',\n        error: (error as Error).message,\n      });\n      socket.close(1011, (error as Error).toString());\n    }\n  }\n}\n"],"mappings":"AACA,SAASA,GAAT,QAAoB,KAApB;SAQSC,e;AAET;AACA,OAAOC,MAAP,MAAmB,wDAAnB;AAEA,MAAMC,aAAa,GAAG,mBAAtB;AACA,MAAMC,eAAe,GAAG,kBAAxB;AAuBA,OAAO,MAAMC,oBAAN,SAAmCJ,eAAnC,CAAmD;EAChDK,OAAO,GAAG,IAAIC,GAAJ,EAAH;EACPC,aAAa,GAAG,CAAH;;EAGrBC,WAAW,CAACC,OAAD,EAAmCC,MAAnC,EAAiE;IAC1E,MAAMD,OAAN,EAAe,CAACP,aAAD,EAAgBC,eAAhB,CAAf;IAD0E,KAA9BO,MAA8B,GAA9BA,MAA8B;IAE1E,KAAKC,UAAL,GAAmB,GAAE,KAAKD,MAAL,CAAYE,IAAZ,IAAoB,WAAY,IAAG,KAAKF,MAAL,CAAYG,IAAK,EAAzE;IACA,KAAKC,KAAL;EACD;;EAEOA,KAAK,GAAG;IACd,MAAMC,MAAM,GAAG,CACbC,QADa,EAEbC,KAFa,EAGbC,QAHa,EAIbC,IAJa,KAKV;MACHF,KAAK,CAACG,OAAN,CAAc;QACZ,gBAAgB,iCADJ;QAEZ,iBAAiB,UAFL;QAGZC,UAAU,EAAE;MAHA,CAAd;MAKAF,IAAI;IACL,CAZD;;IAcA,KAAKV,OAAL,CAAaa,GAAb,CAAiB,eAAjB,EAAkC;MAAEP;IAAF,CAAlC,EAA8C,YAAY;MACxD,OAAO;QACLQ,OAAO,EAAE,mBADJ;QAEL,oBAAoB;MAFf,CAAP;IAID,CALD;;IAOA,MAAMC,eAAe,GAAG,YAAY;MAClC,MAAMC,KAAwB,GAAG,EAAjC;;MACA,KAAK,MAAM,CAACC,QAAD,EAAWC,MAAX,CAAX,IAAiC,KAAKtB,OAAtC,EAA+C;QAC7C,MAAMuB,WAAW,GAAGD,MAAM,CAACE,YAAP,EAApB;;QACA,KAAK,MAAMC,IAAX,IAAmBF,WAAnB,EAAgC;UAC9BH,KAAK,CAACM,IAAN,CAAW,KAAKC,oBAAL,CAA0BN,QAA1B,EAAoCI,IAApC,CAAX;QACD;MACF;;MAED,OAAOL,KAAP;IACD,CAVD;;IAYA,KAAKhB,OAAL,CAAaa,GAAb,CAAiB,YAAjB,EAA+B;MAAEP;IAAF,CAA/B,EAA2CS,eAA3C;IACA,KAAKf,OAAL,CAAaa,GAAb,CACE,OADF,EAEE;MAAEP,MAAF;MAAUkB,QAAQ,EAAE;IAApB,CAFF,EAGET,eAHF;EAKD;;EAEOQ,oBAAoB,CAACN,QAAD,EAAmBI,IAAnB,EAA+B;IACzD,MAAMI,WAAW,GAAI,GAAE,KAAKvB,UAAW,GAAER,eAAgB,WAAUuB,QAAS,SAAQI,IAAI,CAACK,EAAG,EAA5F;IACA,MAAMC,oBAAoB,GAAG,UAAUF,WAAvC;IACA,MAAMG,mBAAmB,GACvB,uFACAC,kBAAkB,CAACJ,WAAD,CAFpB;IAGA,OAAO;MACLC,EAAE,EAAG,GAAET,QAAS,IAAGI,IAAI,CAACK,EAAG,EADtB;MAELI,WAAW,EAAET,IAAI,CAACU,GAFb;MAGLC,KAAK,EAAEX,IAAI,CAACW,KAHP;MAILC,UAAU,EAAE,iCAJP;MAKLL,mBALK;MAMLM,IAAI,EAAE,MAND;MAOLP,oBAPK;MAQLQ,EAAE,EAAEd,IAAI,CAACc;IARJ,CAAP;EAUD;EAED;AACF;AACA;AACA;AACA;AACA;;;EACEC,YAAY,CAACC,MAAD,EAAoBC,OAApB,EAA8C;IACxD,IAAI;MACF,MAAM;QAAEC,GAAG,GAAG;MAAR,IAAeD,OAArB;MACA,MAAM;QAAEE;MAAF,IAAmB,IAAIlD,GAAJ,CAAQiD,GAAR,EAAa,kBAAb,CAAzB;;MAEA,IAAIA,GAAG,CAACE,UAAJ,CAAe,mBAAf,CAAJ,EAAyC;QACvC,MAAMC,UAAU,GAAGF,YAAY,CAAC3B,GAAb,CAAiB,MAAjB,KAA4B,SAA/C;QACA,MAAM8B,OAAO,GAAGH,YAAY,CAAC3B,GAAb,CAAiB,KAAjB,KAA2B,SAA3C;QACA,MAAMI,QAAQ,GAAG,KAAKnB,aAAL,EAAjB;QAEA,KAAKF,OAAL,CAAagD,GAAb,CACE3B,QADF,EAEE,IAAIzB,MAAJ,CAAWyB,QAAX,EAAqByB,UAArB,EAAiCC,OAAjC,EAA0CN,MAA1C,EAAkD,KAAKpC,MAAL,CAAY4C,OAA9D,CAFF;QAKA,KAAK7C,OAAL,CAAa8C,GAAb,CAAiBC,IAAjB,CAAsB;UAAEC,GAAG,EAAE,yBAAP;UAAkC/B;QAAlC,CAAtB;;QAEA,MAAMgC,OAAO,GAAG,MAAM;UACpB,KAAKjD,OAAL,CAAa8C,GAAb,CAAiBC,IAAjB,CAAsB;YACpBC,GAAG,EAAE,4BADe;YAEpB/B;UAFoB,CAAtB;UAIA,KAAKrB,OAAL,CAAasD,MAAb,CAAoBjC,QAApB;QACD,CAND;;QAQAoB,MAAM,CAACc,gBAAP,CAAwB,OAAxB,EAAiCF,OAAjC;QACAZ,MAAM,CAACc,gBAAP,CAAwB,OAAxB,EAAiCF,OAAjC;MACD,CAtBD,MAsBO;QACL,MAAMhC,QAAQ,GAAGuB,YAAY,CAAC3B,GAAb,CAAiB,QAAjB,KAA8BuC,SAA/C;QACA,MAAMC,MAAM,GAAGb,YAAY,CAAC3B,GAAb,CAAiB,MAAjB,KAA4BuC,SAA3C;;QAEA,IAAInC,QAAQ,KAAKmC,SAAb,IAA0BC,MAAM,KAAKD,SAAzC,EAAoD;UAClD,MAAM,IAAIE,KAAJ,CAAU,kDAAV,CAAN;QACD;;QAED,MAAMpC,MAAM,GAAG,KAAKtB,OAAL,CAAaiB,GAAb,CAAiB0C,QAAQ,CAACtC,QAAD,EAAW,EAAX,CAAzB,CAAf;;QACA,IAAI,CAACC,MAAL,EAAa;UACX,MAAM,IAAIoC,KAAJ,CAAU,4BAA4BrC,QAAtC,CAAN;QACD;;QAEDC,MAAM,CAACsC,wBAAP,CAAgCnB,MAAhC,EAAwCgB,MAAxC;MACD;IACF,CAzCD,CAyCE,OAAOI,KAAP,EAAc;MACd,KAAKzD,OAAL,CAAa8C,GAAb,CAAiBW,KAAjB,CAAuB;QACrBT,GAAG,EAAE,mDADgB;QAErBS,KAAK,EAAGA,KAAD,CAAiBC;MAFH,CAAvB;MAIArB,MAAM,CAACsB,KAAP,CAAa,IAAb,EAAoBF,KAAD,CAAiBG,QAAjB,EAAnB;IACD;EACF;;AA9HuD"}