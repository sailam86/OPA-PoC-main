{"version":3,"file":"WebSocketDebuggerServer.js","names":["WebSocketServer","WebSocketDebuggerServer","constructor","fastify","isDebuggerConnected","Boolean","debuggerSocket","send","socket","message","error","log","warn","msg","onConnection","request","url","indexOf","info","onDebuggerConnection","onClientConnection","close","onClose","undefined","clientSocket","removeAllListeners","addEventListener","data","toString","JSON","stringify","method"],"sources":["../../../../src/plugins/wss/servers/WebSocketDebuggerServer.ts"],"sourcesContent":["import type { IncomingMessage } from 'http';\nimport type { FastifyInstance } from 'fastify';\nimport WebSocket from 'ws';\nimport { WebSocketServer } from '../WebSocketServer';\n\n/**\n * Class for creating a WebSocket server and providing a bridge between\n * debugger UI (Remote JS debugger) and the running React Native application.\n *\n * React Native application (aka client) will send and receive messages from the debugger UI\n * which runs inside a browser.\n *\n * @category Development server\n */\nexport class WebSocketDebuggerServer extends WebSocketServer {\n  /**\n   * A WebSocket connection with the debugger UI.\n   */\n  private debuggerSocket: WebSocket | undefined;\n\n  /**\n   * A WebSocket connection with the client (React Native app).\n   */\n  private clientSocket: WebSocket | undefined;\n\n  /**\n   * Create new instance of WebSocketDebuggerServer and attach it to the given Fastify instance.\n   * Any logging information, will be passed through standard `fastify.log` API.\n   *\n   * @param fastify Fastify instance to attach the WebSocket server to.\n   */\n  constructor(fastify: FastifyInstance) {\n    super(fastify, '/debugger-proxy');\n  }\n\n  /**\n   * Check if debugger UI is connected to the WebSocketDebuggerServer.\n   */\n  isDebuggerConnected() {\n    return Boolean(this.debuggerSocket);\n  }\n\n  /**\n   * Send a message to a given WebSocket connection.\n   *\n   * @param socket WebSocket connection to send the message to.\n   * @param message Message to send.\n   */\n  send(socket: WebSocket | undefined, message: string) {\n    try {\n      socket?.send(message);\n    } catch (error) {\n      this.fastify.log.warn({ msg: 'Failed to send data to socket', error });\n    }\n  }\n\n  /**\n   * Process new WebSocket connection. The upgrade request should contain `role` query param\n   * for determining the type of the connection.\n   *\n   * @param socket Incoming WebSocket connection.\n   * @param request Upgrade request for the connection.\n   */\n  onConnection(socket: WebSocket, request: IncomingMessage) {\n    const { url = '' } = request;\n    if (url.indexOf('role=debugger') >= 0) {\n      this.fastify.log.info({ msg: 'Chrome Remote JS debugger connected' });\n      this.onDebuggerConnection(socket);\n    } else if (url.indexOf('role=client') >= 0) {\n      this.fastify.log.info({ msg: 'React Native app connected to debugger' });\n      this.onClientConnection(socket);\n    } else {\n      socket.close(1011, 'Missing role param');\n    }\n  }\n\n  /**\n   * Process new WebSocket connection from Debugger UI (Remote JS Debugger).\n   * If there's already open connection, the new one gets closed automatically.\n   *\n   * @param socket Incoming debugger WebSocket connection.\n   */\n  onDebuggerConnection(socket: WebSocket) {\n    if (this.debuggerSocket) {\n      socket.close(1011, 'Another debugger is already connected');\n      return;\n    }\n    this.debuggerSocket = socket;\n    const onClose = () => {\n      this.fastify.log.info({ msg: 'Chrome Remote JS debugger disconnected' });\n      this.debuggerSocket = undefined;\n      if (this.clientSocket) {\n        this.clientSocket.removeAllListeners();\n        this.clientSocket.close(1011, 'Debugger was disconnected');\n      }\n    };\n    this.debuggerSocket.addEventListener('error', onClose);\n    this.debuggerSocket.addEventListener('close', onClose);\n    this.debuggerSocket.addEventListener('message', ({ data }) => {\n      this.send(this.clientSocket, data.toString());\n    });\n  }\n\n  /**\n   * Process new WebSocket connection from React Native app (client)\n   * and close any previous connection.\n   *\n   * @param socket Incoming client WebSocket connection.\n   */\n  onClientConnection(socket: WebSocket) {\n    if (this.clientSocket) {\n      this.clientSocket.removeAllListeners();\n      this.clientSocket.close(1011, 'Another client is connected');\n      this.clientSocket = undefined;\n    }\n\n    const onClose = () => {\n      this.fastify.log.info({\n        msg: 'React Native app disconnected from debugger',\n      });\n      this.clientSocket = undefined;\n      this.send(\n        this.debuggerSocket,\n        JSON.stringify({ method: '$disconnected' })\n      );\n    };\n\n    this.clientSocket = socket;\n    this.clientSocket.addEventListener('error', onClose);\n    this.clientSocket.addEventListener('close', onClose);\n    this.clientSocket.addEventListener('message', ({ data }) => {\n      this.send(this.debuggerSocket, data.toString());\n    });\n  }\n}\n"],"mappings":"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"}